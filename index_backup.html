<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#ec4899">
  <meta name="description" content="å¦ˆå¦ˆçš„æ‰‹å·¥é¥¼å¹²è®¢å•ç®¡ç†å°åŠ©æ‰‹">
  
  <!-- PWA é…ç½® -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- iOS ç‰¹å®šé…ç½® -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="é¥¼å¹²è®¢å•">
  <link rel="apple-touch-icon" href="/icon-192.png">
  
  <title>é¥¼å¹²è®¢å•ç®¡ç†</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
        sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* é˜²æ­¢ä¸‹æ‹‰åˆ·æ–° */
    body {
      overscroll-behavior-y: contain;
    }
    
    /* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒåŠŸèƒ½ */
    ::-webkit-scrollbar {
      width: 0px;
      background: transparent;
    }

    /* æ—¥å†æ ·å¼ */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      min-height: 60px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React å’Œ ReactDOM CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- ä¸»åº”ç”¨ä»£ç  -->
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    
    // ä½¿ç”¨ React ç»„ä»¶ä»£æ›¿ Lucide å›¾æ ‡
    const IconWrapper = ({ children, size = 20, className = "" }) => (
      <span style={{ display: 'inline-block', width: size, height: size, lineHeight: `${size}px` }} className={className}>
        {children}
      </span>
    );
    
    const Calendar = ({ size, className }) => <IconWrapper size={size} className={className}>ğŸ“…</IconWrapper>;
    const Package = ({ size, className }) => <IconWrapper size={size} className={className}>ğŸ“¦</IconWrapper>;
    const Users = ({ size, className }) => <IconWrapper size={size} className={className}>ğŸ‘¥</IconWrapper>;
    const Plus = ({ size, className }) => <IconWrapper size={size} className={className}>â•</IconWrapper>;
    const Search = ({ size, className }) => <IconWrapper size={size} className={className}>ğŸ”</IconWrapper>;
    const X = ({ size, className }) => <IconWrapper size={size} className={className}>âœ–ï¸</IconWrapper>;
    const Edit2 = ({ size, className }) => <IconWrapper size={size} className={className}>âœï¸</IconWrapper>;
    const Trash2 = ({ size, className }) => <IconWrapper size={size} className={className}>ğŸ—‘ï¸</IconWrapper>;
    const Check = ({ size, className }) => <IconWrapper size={size} className={className}>âœ“</IconWrapper>;
    const AlertCircle = ({ size, className }) => <IconWrapper size={size} className={className}>âš ï¸</IconWrapper>;
    const TrendingUp = ({ size, className }) => <IconWrapper size={size} className={className}>ğŸ“ˆ</IconWrapper>;
    const Settings = ({ size, className }) => <IconWrapper size={size} className={className}>âš™ï¸</IconWrapper>;
    const ChevronLeft = ({ size, className }) => <IconWrapper size={size} className={className}>â—€</IconWrapper>;
    const ChevronRight = ({ size, className }) => <IconWrapper size={size} className={className}>â–¶</IconWrapper>;
    const Filter = ({ size, className }) => <IconWrapper size={size} className={className}>ğŸ”½</IconWrapper>;

    const CookieOrderManager = () => {
      // çŠ¶æ€ç®¡ç†
      const [currentYear, setCurrentYear] = useState(null);
      const [showYearSelector, setShowYearSelector] = useState(false);
      const [activeTab, setActiveTab] = useState('orders');
      const [orders, setOrders] = useState([]);
      const [customers, setCustomers] = useState([]);
      const [products, setProducts] = useState([]);
      const [yearlyData, setYearlyData] = useState({});
      const [settings, setSettings] = useState({ yearlyTarget: 0 });
      
      const [showOrderForm, setShowOrderForm] = useState(false);
      const [showCustomerForm, setShowCustomerForm] = useState(false);
      const [showProductForm, setShowProductForm] = useState(false);
      const [showSettingsForm, setShowSettingsForm] = useState(false);
      const [showFilterPanel, setShowFilterPanel] = useState(false);
      
      const [editingOrder, setEditingOrder] = useState(null);
      const [editingCustomer, setEditingCustomer] = useState(null);
      const [editingProduct, setEditingProduct] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      
      // æ—¥å†çŠ¶æ€
      const [calendarDate, setCalendarDate] = useState(new Date());
      
      // è¿‡æ»¤çŠ¶æ€
      const [filterStatus, setFilterStatus] = useState('all');
      const [filterDateType, setFilterDateType] = useState('all'); // all, past, upcoming
      const [filterDateRange, setFilterDateRange] = useState({ start: '', end: '' });

      // åˆå§‹åŒ–ï¼šä» localStorage åŠ è½½æ•°æ®
      useEffect(() => {
        const savedYearlyData = localStorage.getItem('cookieYearlyData');
        const savedSettings = localStorage.getItem('cookieSettings');
        
        if (savedYearlyData) {
          const data = JSON.parse(savedYearlyData);
          setYearlyData(data);
          
          // è·å–æ‰€æœ‰å¹´ä»½
          const years = Object.keys(data).sort((a, b) => b - a);
          const currentYearNum = new Date().getFullYear();
          
          // å¦‚æœå½“å‰å¹´ä»½å­˜åœ¨ï¼Œä½¿ç”¨å½“å‰å¹´ä»½ï¼›å¦åˆ™ä½¿ç”¨æœ€æ–°å¹´ä»½
          if (data[currentYearNum]) {
            setCurrentYear(currentYearNum);
          } else if (years.length > 0) {
            setCurrentYear(parseInt(years[0]));
          } else {
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ›å»ºå½“å‰å¹´ä»½
            const newYear = currentYearNum;
            setYearlyData({ [newYear]: { settled: false } });
            setCurrentYear(newYear);
          }
        } else {
          // é¦–æ¬¡ä½¿ç”¨ï¼Œåˆ›å»ºå½“å‰å¹´ä»½
          const newYear = new Date().getFullYear();
          setYearlyData({ [newYear]: { settled: false } });
          setCurrentYear(newYear);
        }
        
        if (savedSettings) {
          setSettings(JSON.parse(savedSettings));
        }
      }, []);

      // å½“å¹´ä»½æ”¹å˜æ—¶ï¼ŒåŠ è½½å¯¹åº”å¹´ä»½çš„æ•°æ®
      useEffect(() => {
        if (currentYear) {
          const savedOrders = localStorage.getItem(`cookieOrders_${currentYear}`);
          const savedCustomers = localStorage.getItem('cookieCustomers');
          const savedProducts = localStorage.getItem('cookieProducts');
          
          if (savedOrders) setOrders(JSON.parse(savedOrders));
          else setOrders([]);
          
          if (savedCustomers) setCustomers(JSON.parse(savedCustomers));
          if (savedProducts) setProducts(JSON.parse(savedProducts));
        }
      }, [currentYear]);

      // ä¿å­˜æ•°æ®åˆ° localStorage
      useEffect(() => {
        if (currentYear) {
          localStorage.setItem(`cookieOrders_${currentYear}`, JSON.stringify(orders));
        }
      }, [orders, currentYear]);

      useEffect(() => {
        localStorage.setItem('cookieCustomers', JSON.stringify(customers));
      }, [customers]);

      useEffect(() => {
        localStorage.setItem('cookieProducts', JSON.stringify(products));
      }, [products]);

      useEffect(() => {
        localStorage.setItem('cookieYearlyData', JSON.stringify(yearlyData));
      }, [yearlyData]);

      useEffect(() => {
        localStorage.setItem('cookieSettings', JSON.stringify(settings));
      }, [settings]);

      // æ£€æŸ¥å½“å‰å¹´ä»½æ˜¯å¦å·²ç»“ç®—
      const isCurrentYearSettled = useMemo(() => {
        return yearlyData[currentYear]?.settled || false;
      }, [yearlyData, currentYear]);

      // è®¢å•è¡¨å•çŠ¶æ€
      const [orderForm, setOrderForm] = useState({
        customerId: '',
        customerName: '',
        phone: '',
        items: [{ productId: '', productName: '', size: '', quantity: 1, price: 0 }],
        deliveryDate: '',
        notes: '',
        status: 'pending'
      });

      // å®¢æˆ·è¡¨å•çŠ¶æ€
      const [customerForm, setCustomerForm] = useState({
        name: '',
        phone: '',
        address: '',
        notes: ''
      });

      // äº§å“è¡¨å•çŠ¶æ€
      const [productForm, setProductForm] = useState({
        name: '',
        sizes: [{ name: 'æ ‡å‡†', price: '' }],
        unit: 'ç›’',
        description: ''
      });

      // è®¢å•ç®¡ç†å‡½æ•°
      const saveOrder = () => {
        if (isCurrentYearSettled) {
          alert('æœ¬å¹´åº¦å·²ç»“ç®—ï¼Œæ— æ³•æ·»åŠ æˆ–ä¿®æ”¹è®¢å•');
          return;
        }

        if (!orderForm.customerName || !orderForm.phone || !orderForm.deliveryDate) {
          alert('è¯·å¡«å†™å®¢æˆ·å§“åã€ç”µè¯å’Œäº¤è´§æ—¥æœŸ');
          return;
        }

        const validItems = orderForm.items.filter(item => item.productName && item.quantity > 0);
        if (validItems.length === 0) {
          alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªäº§å“');
          return;
        }

        const totalAmount = validItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

        if (editingOrder) {
          setOrders(orders.map(order => 
            order.id === editingOrder.id 
              ? { ...orderForm, items: validItems, totalAmount, id: order.id, createdAt: order.createdAt }
              : order
          ));
        } else {
          const newOrder = {
            ...orderForm,
            items: validItems,
            totalAmount,
            id: Date.now(),
            createdAt: new Date().toISOString()
          };
          setOrders([...orders, newOrder]);
        }

        resetOrderForm();
      };

      const deleteOrder = (id) => {
        if (isCurrentYearSettled) {
          alert('æœ¬å¹´åº¦å·²ç»“ç®—ï¼Œæ— æ³•åˆ é™¤è®¢å•');
          return;
        }
        
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢å•å—ï¼Ÿ')) {
          setOrders(orders.filter(order => order.id !== id));
        }
      };

      const updateOrderStatus = (id, newStatus) => {
        if (isCurrentYearSettled) {
          alert('æœ¬å¹´åº¦å·²ç»“ç®—ï¼Œæ— æ³•æ›´æ”¹è®¢å•çŠ¶æ€');
          return;
        }
        
        setOrders(orders.map(order => 
          order.id === id ? { ...order, status: newStatus } : order
        ));
      };

      const resetOrderForm = () => {
        setOrderForm({
          customerId: '',
          customerName: '',
          phone: '',
          items: [{ productId: '', productName: '', size: '', quantity: 1, price: 0 }],
          deliveryDate: '',
          notes: '',
          status: 'pending'
        });
        setEditingOrder(null);
        setShowOrderForm(false);
      };

      const editOrder = (order) => {
        if (isCurrentYearSettled) {
          alert('æœ¬å¹´åº¦å·²ç»“ç®—ï¼Œæ— æ³•ç¼–è¾‘è®¢å•');
          return;
        }
        
        setOrderForm(order);
        setEditingOrder(order);
        setShowOrderForm(true);
      };

      // å®¢æˆ·ç®¡ç†å‡½æ•°
      const saveCustomer = () => {
        if (!customerForm.name || !customerForm.phone) {
          alert('è¯·å¡«å†™å®¢æˆ·å§“åå’Œç”µè¯');
          return;
        }

        if (editingCustomer) {
          const oldCustomer = customers.find(c => c.id === editingCustomer.id);
          
          setCustomers(customers.map(customer => 
            customer.id === editingCustomer.id 
              ? { ...customerForm, id: customer.id }
              : customer
          ));
          
          // æ›´æ–°æ‰€æœ‰è®¢å•ä¸­çš„å®¢æˆ·ä¿¡æ¯
          if (oldCustomer.name !== customerForm.name || oldCustomer.phone !== customerForm.phone) {
            setOrders(orders.map(order => {
              if (order.customerId === editingCustomer.id) {
                return {
                  ...order,
                  customerName: customerForm.name,
                  phone: customerForm.phone
                };
              }
              return order;
            }));
          }
        } else {
          const newCustomer = {
            ...customerForm,
            id: Date.now()
          };
          setCustomers([...customers, newCustomer]);
        }

        resetCustomerForm();
      };

      const deleteCustomer = (id) => {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®¢æˆ·å—ï¼Ÿ')) {
          setCustomers(customers.filter(customer => customer.id !== id));
        }
      };

      const resetCustomerForm = () => {
        setCustomerForm({ name: '', phone: '', address: '', notes: '' });
        setEditingCustomer(null);
        setShowCustomerForm(false);
      };

      const editCustomer = (customer) => {
        setCustomerForm(customer);
        setEditingCustomer(customer);
        setShowCustomerForm(true);
      };

      const selectCustomer = (customer) => {
        setOrderForm({
          ...orderForm,
          customerId: customer.id,
          customerName: customer.name,
          phone: customer.phone
        });
      };

      // äº§å“ç®¡ç†å‡½æ•°
      const saveProduct = () => {
        if (!productForm.name) {
          alert('è¯·å¡«å†™äº§å“åç§°');
          return;
        }

        const validSizes = productForm.sizes.filter(s => s.name && s.price);
        if (validSizes.length === 0) {
          alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªå¤§å°å’Œä»·æ ¼');
          return;
        }

        const formattedSizes = validSizes.map(s => ({
          name: s.name,
          price: parseFloat(s.price)
        }));

        if (editingProduct) {
          setProducts(products.map(product => 
            product.id === editingProduct.id 
              ? { ...productForm, sizes: formattedSizes, id: product.id }
              : product
          ));
        } else {
          const newProduct = {
            ...productForm,
            sizes: formattedSizes,
            id: Date.now()
          };
          setProducts([...products, newProduct]);
        }

        resetProductForm();
      };

      const deleteProduct = (id) => {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº§å“å—ï¼Ÿ')) {
          setProducts(products.filter(product => product.id !== id));
        }
      };

      const resetProductForm = () => {
        setProductForm({ name: '', sizes: [{ name: 'æ ‡å‡†', price: '' }], unit: 'ç›’', description: '' });
        setEditingProduct(null);
        setShowProductForm(false);
      };

      const editProduct = (product) => {
        setProductForm({ 
          ...product, 
          sizes: product.sizes.map(s => ({ ...s, price: s.price.toString() }))
        });
        setEditingProduct(product);
        setShowProductForm(true);
      };

      const addProductSize = () => {
        setProductForm({
          ...productForm,
          sizes: [...productForm.sizes, { name: '', price: '' }]
        });
      };

      const removeProductSize = (index) => {
        const newSizes = productForm.sizes.filter((_, i) => i !== index);
        setProductForm({ ...productForm, sizes: newSizes });
      };

      const updateProductSize = (index, field, value) => {
        const newSizes = [...productForm.sizes];
        newSizes[index][field] = value;
        setProductForm({ ...productForm, sizes: newSizes });
      };

      // æ·»åŠ è®¢å•é¡¹
      const addOrderItem = () => {
        setOrderForm({
          ...orderForm,
          items: [...orderForm.items, { productId: '', productName: '', size: '', quantity: 1, price: 0 }]
        });
      };

      const removeOrderItem = (index) => {
        const newItems = orderForm.items.filter((_, i) => i !== index);
        setOrderForm({ ...orderForm, items: newItems });
      };

      const updateOrderItem = (index, field, value) => {
        const newItems = [...orderForm.items];
        newItems[index][field] = value;
        
        if (field === 'productId') {
          const product = products.find(p => p.id === parseInt(value));
          if (product) {
            newItems[index].productName = product.name;
            newItems[index].productId = parseInt(value); // ç¡®ä¿å­˜å‚¨ä¸ºæ•°å­—
            // é‡ç½®å¤§å°å’Œä»·æ ¼ï¼Œè®©ç”¨æˆ·é€‰æ‹©
            newItems[index].size = '';
            newItems[index].price = 0;
          }
        }
        
        if (field === 'size') {
          // ç¡®ä¿ productId å­˜åœ¨ä¸”æ­£ç¡®
          const productId = parseInt(newItems[index].productId);
          const product = products.find(p => p.id === productId);
          if (product) {
            const size = product.sizes.find(s => s.name === value);
            if (size) {
              newItems[index].price = size.price;
            }
          }
        }
        
        setOrderForm({ ...orderForm, items: newItems });
      };

      // è·å–çŠ¶æ€æ ‡ç­¾æ ·å¼
      const getStatusBadge = (status) => {
        const statusConfig = {
          pending: { label: 'å¾…ç¡®è®¤', color: 'bg-yellow-100 text-yellow-800' },
          confirmed: { label: 'åˆ¶ä½œä¸­', color: 'bg-blue-100 text-blue-800' },
          completed: { label: 'å·²å®Œæˆ', color: 'bg-green-100 text-green-800' },
          delivered: { label: 'å·²äº¤ä»˜', color: 'bg-gray-100 text-gray-800' }
        };
        const config = statusConfig[status] || statusConfig.pending;
        return <span className={`px-2 py-1 rounded-full text-xs font-medium ${config.color}`}>{config.label}</span>;
      };

      // æ£€æŸ¥å³å°†åˆ°æœŸçš„è®¢å•
      const getUpcomingOrders = () => {
        const today = new Date();
        const threeDaysLater = new Date(today);
        threeDaysLater.setDate(today.getDate() + 3);

        return orders.filter(order => {
          const deliveryDate = new Date(order.deliveryDate);
          return deliveryDate >= today && 
                 deliveryDate <= threeDaysLater && 
                 (order.status === 'pending' || order.status === 'confirmed');
        }).sort((a, b) => new Date(a.deliveryDate) - new Date(b.deliveryDate));
      };

      // è¿‡æ»¤è®¢å•
      const filteredOrders = useMemo(() => {
        let filtered = orders.filter(order => 
          order.customerName.toLowerCase().includes(searchTerm.toLowerCase()) ||
          order.phone.includes(searchTerm) ||
          order.items.some(item => item.productName.toLowerCase().includes(searchTerm.toLowerCase()))
        );

        // çŠ¶æ€è¿‡æ»¤
        if (filterStatus !== 'all') {
          filtered = filtered.filter(order => order.status === filterStatus);
        }

        // æ—¥æœŸè¿‡æ»¤
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (filterDateType === 'past') {
          filtered = filtered.filter(order => new Date(order.deliveryDate) < today);
        } else if (filterDateType === 'upcoming') {
          filtered = filtered.filter(order => new Date(order.deliveryDate) >= today);
        }

        // è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´è¿‡æ»¤
        if (filterDateRange.start) {
          filtered = filtered.filter(order => 
            new Date(order.deliveryDate) >= new Date(filterDateRange.start)
          );
        }
        if (filterDateRange.end) {
          filtered = filtered.filter(order => 
            new Date(order.deliveryDate) <= new Date(filterDateRange.end)
          );
        }

        return filtered;
      }, [orders, searchTerm, filterStatus, filterDateType, filterDateRange]);

      // æ ¼å¼åŒ–æ—¥æœŸ
      const formatDate = (dateString) => {
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
      };

      // è®¡ç®—è·ç¦»äº¤è´§æ—¥æœŸçš„å¤©æ•°
      const getDaysUntilDelivery = (deliveryDate) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const delivery = new Date(deliveryDate);
        delivery.setHours(0, 0, 0, 0);
        const diffTime = delivery - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
      };

      // æ—¥å†åŠŸèƒ½
      const getCalendarDays = () => {
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        
        const days = [];
        
        // æ·»åŠ ç©ºç™½å¤©æ•°
        for (let i = 0; i < startingDayOfWeek; i++) {
          days.push(null);
        }
        
        // æ·»åŠ å®é™…å¤©æ•°
        for (let i = 1; i <= daysInMonth; i++) {
          days.push(i);
        }
        
        return days;
      };

      const getOrdersForDate = (day) => {
        if (!day) return [];
        
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        return orders.filter(order => order.deliveryDate === dateStr);
      };

      const previousMonth = () => {
        setCalendarDate(new Date(calendarDate.getFullYear(), calendarDate.getMonth() - 1, 1));
      };

      const nextMonth = () => {
        setCalendarDate(new Date(calendarDate.getFullYear(), calendarDate.getMonth() + 1, 1));
      };

      // é”€å”®ç»Ÿè®¡
      const salesStats = useMemo(() => {
        const deliveredOrders = orders.filter(order => order.status === 'delivered');
        
        const totalRevenue = deliveredOrders.reduce((sum, order) => sum + order.totalAmount, 0);
        
        const productCount = {};
        deliveredOrders.forEach(order => {
          order.items.forEach(item => {
            const key = `${item.productName} - ${item.size}`;
            productCount[key] = (productCount[key] || 0) + item.quantity;
          });
        });
        
        const progress = settings.yearlyTarget > 0 ? (totalRevenue / settings.yearlyTarget) * 100 : 0;
        
        return {
          totalRevenue,
          orderCount: deliveredOrders.length,
          productCount,
          progress: Math.min(progress, 100)
        };
      }, [orders, settings.yearlyTarget]);

      // å¹´ä»½ç»“ç®—
      const settleYear = () => {
        if (confirm(`ç¡®å®šè¦ç»“ç®— ${currentYear} å¹´åº¦å—ï¼Ÿç»“ç®—åè¯¥å¹´åº¦çš„è®¢å•å°†æ— æ³•ä¿®æ”¹ã€‚`)) {
          setYearlyData({
            ...yearlyData,
            [currentYear]: {
              ...yearlyData[currentYear],
              settled: true,
              settlementDate: new Date().toISOString(),
              finalRevenue: salesStats.totalRevenue,
              finalOrderCount: salesStats.orderCount
            },
            [currentYear + 1]: {
              settled: false
            }
          });
          
          alert(`${currentYear} å¹´åº¦å·²ç»“ç®—ï¼å·²è‡ªåŠ¨åˆ›å»º ${currentYear + 1} å¹´åº¦ã€‚`);
        }
      };

      // å¹´ä»½é€‰æ‹©å™¨
      const availableYears = useMemo(() => {
        return Object.keys(yearlyData).sort((a, b) => b - a);
      }, [yearlyData]);

      const selectYear = (year) => {
        setCurrentYear(parseInt(year));
        setShowYearSelector(false);
      };

      // å¦‚æœè¿˜æ²¡é€‰æ‹©å¹´ä»½ï¼Œæ˜¾ç¤ºå¹´ä»½é€‰æ‹©å™¨
      if (!currentYear) {
        return <div className="min-h-screen bg-gray-50 flex items-center justify-center">
          <div className="text-center">
            <div className="text-4xl mb-4">ğŸª</div>
            <div className="text-xl font-bold">åŠ è½½ä¸­...</div>
          </div>
        </div>;
      }

      return (
        <div className="min-h-screen bg-gray-50">
          {/* å¤´éƒ¨ */}
          <div className="bg-pink-500 text-white p-4 shadow-lg">
            <div className="flex justify-between items-center">
              <div className="flex-1">
                <h1 className="text-2xl font-bold">ğŸª é¥¼å¹²è®¢å•ç®¡ç†</h1>
                <p className="text-sm opacity-90 mt-1">å¦ˆå¦ˆçš„æ‰‹å·¥é¥¼å¹²å°åŠ©æ‰‹</p>
              </div>
              <button
                onClick={() => setShowYearSelector(true)}
                className="bg-white bg-opacity-20 px-4 py-2 rounded-lg font-medium"
              >
                {currentYear} å¹´
                {isCurrentYearSettled && <span className="ml-2 text-xs">âœ“ å·²ç»“ç®—</span>}
              </button>
            </div>
          </div>

          {/* æé†’æ  */}
          {activeTab === 'orders' && getUpcomingOrders().length > 0 && (
            <div className="bg-orange-50 border-l-4 border-orange-400 p-4 mx-4 mt-4 rounded">
              <div className="flex items-start">
                <AlertCircle className="text-orange-400 mr-2 flex-shrink-0 mt-0.5" size={20} />
                <div>
                  <p className="font-medium text-orange-800">å³å°†åˆ°æœŸçš„è®¢å•</p>
                  {getUpcomingOrders().map(order => {
                    const daysUntil = getDaysUntilDelivery(order.deliveryDate);
                    return (
                      <p key={order.id} className="text-sm text-orange-700 mt-1">
                        â€¢ {order.customerName} - {formatDate(order.deliveryDate)} 
                        {daysUntil === 0 ? ' (ä»Šå¤©)' : daysUntil === 1 ? ' (æ˜å¤©)' : ` (${daysUntil}å¤©å)`}
                      </p>
                    );
                  })}
                </div>
              </div>
            </div>
          )}

          {/* å¯¼èˆªæ ‡ç­¾ */}
          <div className="flex bg-white shadow-sm overflow-x-auto">
            <button
              onClick={() => setActiveTab('orders')}
              className={`flex-1 py-4 px-4 font-medium text-sm flex items-center justify-center gap-2 border-b-2 ${
                activeTab === 'orders' ? 'border-pink-500 text-pink-600' : 'border-transparent text-gray-500'
              }`}
            >
              <Package size={20} />
              è®¢å•
            </button>
            <button
              onClick={() => setActiveTab('calendar')}
              className={`flex-1 py-4 px-4 font-medium text-sm flex items-center justify-center gap-2 border-b-2 ${
                activeTab === 'calendar' ? 'border-pink-500 text-pink-600' : 'border-transparent text-gray-500'
              }`}
            >
              <Calendar size={20} />
              æ—¥å†
            </button>
            <button
              onClick={() => setActiveTab('customers')}
              className={`flex-1 py-4 px-4 font-medium text-sm flex items-center justify-center gap-2 border-b-2 ${
                activeTab === 'customers' ? 'border-pink-500 text-pink-600' : 'border-transparent text-gray-500'
              }`}
            >
              <Users size={20} />
              å®¢æˆ·
            </button>
            <button
              onClick={() => setActiveTab('products')}
              className={`flex-1 py-4 px-4 font-medium text-sm flex items-center justify-center gap-2 border-b-2 ${
                activeTab === 'products' ? 'border-pink-500 text-pink-600' : 'border-transparent text-gray-500'
              }`}
            >
              <Package size={20} />
              äº§å“
            </button>
            <button
              onClick={() => setActiveTab('stats')}
              className={`flex-1 py-4 px-4 font-medium text-sm flex items-center justify-center gap-2 border-b-2 ${
                activeTab === 'stats' ? 'border-pink-500 text-pink-600' : 'border-transparent text-gray-500'
              }`}
            >
              <TrendingUp size={20} />
              ç»Ÿè®¡
            </button>
          </div>

          {/* ä¸»å†…å®¹åŒº */}
          <div className="p-4">
            {/* è®¢å•ç®¡ç† */}
            {activeTab === 'orders' && (
              <div>
                {/* æœç´¢å’Œè¿‡æ»¤æ  */}
                <div className="mb-4 space-y-2">
                  <div className="relative">
                    <Search className="absolute left-3 top-3 text-gray-400" size={20} />
                    <input
                      type="text"
                      placeholder="æœç´¢å®¢æˆ·å§“åã€ç”µè¯æˆ–äº§å“..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500"
                    />
                  </div>
                  
                  <button
                    onClick={() => setShowFilterPanel(!showFilterPanel)}
                    className="w-full py-2 px-4 bg-gray-100 rounded-lg flex items-center justify-center gap-2 text-gray-700"
                  >
                    <Filter size={16} />
                    è¿‡æ»¤é€‰é¡¹
                  </button>
                  
                  {showFilterPanel && (
                    <div className="bg-white border border-gray-300 rounded-lg p-4 space-y-3">
                      <div>
                        <label className="block text-sm font-medium mb-2">è®¢å•çŠ¶æ€</label>
                        <select
                          value={filterStatus}
                          onChange={(e) => setFilterStatus(e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                        >
                          <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                          <option value="pending">å¾…ç¡®è®¤</option>
                          <option value="confirmed">åˆ¶ä½œä¸­</option>
                          <option value="completed">å·²å®Œæˆ</option>
                          <option value="delivered">å·²äº¤ä»˜</option>
                        </select>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium mb-2">äº¤è´§æ—¥æœŸ</label>
                        <select
                          value={filterDateType}
                          onChange={(e) => {
                            setFilterDateType(e.target.value);
                            if (e.target.value !== 'custom') {
                              setFilterDateRange({ start: '', end: '' });
                            }
                          }}
                          className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                        >
                          <option value="all">å…¨éƒ¨æ—¥æœŸ</option>
                          <option value="past">å·²è¿‡å»</option>
                          <option value="upcoming">å³å°†åˆ°æ¥</option>
                          <option value="custom">è‡ªå®šä¹‰èŒƒå›´</option>
                        </select>
                      </div>
                      
                      {filterDateType === 'custom' && (
                        <div className="grid grid-cols-2 gap-2">
                          <div>
                            <label className="block text-xs font-medium mb-1">å¼€å§‹æ—¥æœŸ</label>
                            <input
                              type="date"
                              value={filterDateRange.start}
                              onChange={(e) => setFilterDateRange({ ...filterDateRange, start: e.target.value })}
                              className="w-full px-2 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-pink-500"
                            />
                          </div>
                          <div>
                            <label className="block text-xs font-medium mb-1">ç»“æŸæ—¥æœŸ</label>
                            <input
                              type="date"
                              value={filterDateRange.end}
                              onChange={(e) => setFilterDateRange({ ...filterDateRange, end: e.target.value })}
                              className="w-full px-2 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-pink-500"
                            />
                          </div>
                        </div>
                      )}
                      
                      <button
                        onClick={() => {
                          setFilterStatus('all');
                          setFilterDateType('all');
                          setFilterDateRange({ start: '', end: '' });
                          setShowFilterPanel(false);
                        }}
                        className="w-full py-2 bg-gray-200 rounded text-sm"
                      >
                        æ¸…é™¤è¿‡æ»¤
                      </button>
                    </div>
                  )}
                </div>

                {/* è®¢å•åˆ—è¡¨ */}
                <div className="space-y-3 mb-20">
                  {filteredOrders.length === 0 ? (
                    <div className="text-center py-12 text-gray-500">
                      <Package size={48} className="mx-auto mb-3 opacity-50" />
                      <p>æ²¡æœ‰æ‰¾åˆ°è®¢å•</p>
                      <p className="text-sm">å°è¯•è°ƒæ•´æœç´¢æˆ–è¿‡æ»¤æ¡ä»¶</p>
                    </div>
                  ) : (
                    filteredOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).map(order => (
                      <div key={order.id} className="bg-white rounded-lg shadow p-4">
                        <div className="flex justify-between items-start mb-3">
                          <div className="flex-1">
                            <h3 className="font-bold text-lg">{order.customerName}</h3>
                            <p className="text-sm text-gray-600">{order.phone}</p>
                          </div>
                          {getStatusBadge(order.status)}
                        </div>

                        <div className="mb-3 bg-gray-50 rounded p-2">
                          {order.items.map((item, idx) => (
                            <div key={idx} className="text-sm py-1">
                              {item.productName} {item.size && `(${item.size})`} Ã— {item.quantity} = RM{(item.price * item.quantity).toFixed(2)}
                            </div>
                          ))}
                          <div className="text-sm font-bold pt-2 border-t border-gray-200 mt-2">
                            æ€»è®¡: RM{order.totalAmount.toFixed(2)}
                          </div>
                        </div>

                        <div className="flex items-center text-sm text-gray-600 mb-3">
                          <Calendar size={16} className="mr-1" />
                          äº¤è´§æ—¥æœŸ: {formatDate(order.deliveryDate)}
                          {getDaysUntilDelivery(order.deliveryDate) <= 3 && order.status !== 'delivered' && getDaysUntilDelivery(order.deliveryDate) >= 0 && (
                            <span className="ml-2 text-orange-600 font-medium">
                              ({getDaysUntilDelivery(order.deliveryDate) === 0 ? 'ä»Šå¤©' : 
                                getDaysUntilDelivery(order.deliveryDate) === 1 ? 'æ˜å¤©' : 
                                `${getDaysUntilDelivery(order.deliveryDate)}å¤©å`})
                            </span>
                          )}
                        </div>

                        {order.notes && (
                          <p className="text-sm text-gray-600 mb-3">å¤‡æ³¨: {order.notes}</p>
                        )}

                        {!isCurrentYearSettled && (
                          <>
                            <div className="flex gap-2 mb-3 overflow-x-auto">
                              {order.status === 'pending' && (
                                <button
                                  onClick={() => updateOrderStatus(order.id, 'confirmed')}
                                  className="px-3 py-1 bg-blue-500 text-white rounded text-sm whitespace-nowrap"
                                >
                                  å¼€å§‹åˆ¶ä½œ
                                </button>
                              )}
                              {order.status === 'confirmed' && (
                                <button
                                  onClick={() => updateOrderStatus(order.id, 'completed')}
                                  className="px-3 py-1 bg-green-500 text-white rounded text-sm whitespace-nowrap"
                                >
                                  åˆ¶ä½œå®Œæˆ
                                </button>
                              )}
                              {order.status === 'completed' && (
                                <button
                                  onClick={() => updateOrderStatus(order.id, 'delivered')}
                                  className="px-3 py-1 bg-gray-500 text-white rounded text-sm whitespace-nowrap"
                                >
                                  å·²äº¤ä»˜
                                </button>
                              )}
                            </div>

                            <div className="flex gap-2">
                              <button
                                onClick={() => editOrder(order)}
                                className="flex-1 py-2 bg-gray-100 text-gray-700 rounded font-medium text-sm flex items-center justify-center gap-1"
                              >
                                <Edit2 size={16} />
                                ç¼–è¾‘
                              </button>
                              <button
                                onClick={() => deleteOrder(order.id)}
                                className="flex-1 py-2 bg-red-50 text-red-600 rounded font-medium text-sm flex items-center justify-center gap-1"
                              >
                                <Trash2 size={16} />
                                åˆ é™¤
                              </button>
                            </div>
                          </>
                        )}
                        
                        {isCurrentYearSettled && (
                          <div className="text-center text-sm text-gray-500 py-2">
                            æœ¬å¹´åº¦å·²ç»“ç®—ï¼Œè®¢å•å·²é”å®š
                          </div>
                        )}
                      </div>
                    ))
                  )}
                </div>

                {!isCurrentYearSettled && (
                  <button
                    onClick={() => setShowOrderForm(true)}
                    className="fixed bottom-6 right-6 bg-pink-500 text-white rounded-full p-4 shadow-lg flex items-center gap-2 font-medium"
                  >
                    <Plus size={24} />
                    <span>æ–°è®¢å•</span>
                  </button>
                )}
              </div>
            )}

            {/* æ—¥å†è§†å›¾ */}
            {activeTab === 'calendar' && (
              <div>
                <div className="bg-white rounded-lg shadow p-4 mb-4">
                  <div className="flex items-center justify-between mb-4">
                    <button onClick={previousMonth} className="p-2">
                      <ChevronLeft size={24} />
                    </button>
                    <h2 className="text-xl font-bold">
                      {calendarDate.getFullYear()}å¹´ {calendarDate.getMonth() + 1}æœˆ
                    </h2>
                    <button onClick={nextMonth} className="p-2">
                      <ChevronRight size={24} />
                    </button>
                  </div>
                  
                  <div className="calendar-grid mb-2">
                    {['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(day => (
                      <div key={day} className="text-center text-sm font-medium text-gray-600 py-2">
                        {day}
                      </div>
                    ))}
                  </div>
                  
                  <div className="calendar-grid">
                    {getCalendarDays().map((day, index) => {
                      const dayOrders = getOrdersForDate(day);
                      return (
                        <div
                          key={index}
                          className={`calendar-day border rounded p-1 ${
                            day ? 'bg-white' : 'bg-gray-50'
                          } ${dayOrders.length > 0 ? 'border-pink-300 bg-pink-50' : 'border-gray-200'}`}
                        >
                          {day && (
                            <>
                              <div className="text-xs font-medium text-gray-700 mb-1">{day}</div>
                              <div className="space-y-1">
                                {dayOrders.slice(0, 2).map(order => (
                                  <div
                                    key={order.id}
                                    onClick={() => editOrder(order)}
                                    className="text-xs bg-pink-100 text-pink-800 rounded px-1 py-0.5 cursor-pointer hover:bg-pink-200 truncate"
                                  >
                                    {order.customerName}
                                  </div>
                                ))}
                                {dayOrders.length > 2 && (
                                  <div className="text-xs text-gray-500">
                                    +{dayOrders.length - 2} æ›´å¤š
                                  </div>
                                )}
                              </div>
                            </>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            )}

            {/* å®¢æˆ·ç®¡ç† */}
            {activeTab === 'customers' && (
              <div>
                <div className="space-y-3 mb-20">
                  {customers.length === 0 ? (
                    <div className="text-center py-12 text-gray-500">
                      <Users size={48} className="mx-auto mb-3 opacity-50" />
                      <p>è¿˜æ²¡æœ‰å®¢æˆ·èµ„æ–™</p>
                      <p className="text-sm">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ å®¢æˆ·</p>
                    </div>
                  ) : (
                    customers.map(customer => (
                      <div key={customer.id} className="bg-white rounded-lg shadow p-4">
                        <div className="flex justify-between items-start mb-2">
                          <div>
                            <h3 className="font-bold text-lg">{customer.name}</h3>
                            <p className="text-sm text-gray-600">{customer.phone}</p>
                          </div>
                        </div>
                        {customer.address && (
                          <p className="text-sm text-gray-600 mb-2">åœ°å€: {customer.address}</p>
                        )}
                        {customer.notes && (
                          <p className="text-sm text-gray-600 mb-3">å¤‡æ³¨: {customer.notes}</p>
                        )}
                        <div className="flex gap-2">
                          <button
                            onClick={() => editCustomer(customer)}
                            className="flex-1 py-2 bg-gray-100 text-gray-700 rounded font-medium text-sm flex items-center justify-center gap-1"
                          >
                            <Edit2 size={16} />
                            ç¼–è¾‘
                          </button>
                          <button
                            onClick={() => deleteCustomer(customer.id)}
                            className="flex-1 py-2 bg-red-50 text-red-600 rounded font-medium text-sm flex items-center justify-center gap-1"
                          >
                            <Trash2 size={16} />
                            åˆ é™¤
                          </button>
                        </div>
                      </div>
                    ))
                  )}
                </div>

                <button
                  onClick={() => setShowCustomerForm(true)}
                  className="fixed bottom-6 right-6 bg-pink-500 text-white rounded-full p-4 shadow-lg flex items-center gap-2 font-medium"
                >
                  <Plus size={24} />
                  <span>æ–°å®¢æˆ·</span>
                </button>
              </div>
            )}

            {/* äº§å“ç®¡ç† */}
            {activeTab === 'products' && (
              <div>
                <div className="space-y-3 mb-20">
                  {products.length === 0 ? (
                    <div className="text-center py-12 text-gray-500">
                      <Package size={48} className="mx-auto mb-3 opacity-50" />
                      <p>è¿˜æ²¡æœ‰äº§å“</p>
                      <p className="text-sm">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ äº§å“</p>
                    </div>
                  ) : (
                    products.map(product => (
                      <div key={product.id} className="bg-white rounded-lg shadow p-4">
                        <div className="flex justify-between items-start mb-2">
                          <div className="flex-1">
                            <h3 className="font-bold text-lg">{product.name}</h3>
                            <div className="mt-2 space-y-1">
                              {product.sizes.map((size, idx) => (
                                <div key={idx} className="text-sm">
                                  <span className="font-medium text-gray-700">{size.name}:</span>
                                  <span className="ml-2 text-pink-600 font-bold">
                                    RM{size.price.toFixed(2)} / {product.unit}
                                  </span>
                                </div>
                              ))}
                            </div>
                          </div>
                        </div>
                        {product.description && (
                          <p className="text-sm text-gray-600 mb-3">{product.description}</p>
                        )}
                        <div className="flex gap-2">
                          <button
                            onClick={() => editProduct(product)}
                            className="flex-1 py-2 bg-gray-100 text-gray-700 rounded font-medium text-sm flex items-center justify-center gap-1"
                          >
                            <Edit2 size={16} />
                            ç¼–è¾‘
                          </button>
                          <button
                            onClick={() => deleteProduct(product.id)}
                            className="flex-1 py-2 bg-red-50 text-red-600 rounded font-medium text-sm flex items-center justify-center gap-1"
                          >
                            <Trash2 size={16} />
                            åˆ é™¤
                          </button>
                        </div>
                      </div>
                    ))
                  )}
                </div>

                <button
                  onClick={() => setShowProductForm(true)}
                  className="fixed bottom-6 right-6 bg-pink-500 text-white rounded-full p-4 shadow-lg flex items-center gap-2 font-medium"
                >
                  <Plus size={24} />
                  <span>æ–°äº§å“</span>
                </button>
              </div>
            )}

            {/* ç»Ÿè®¡é¡µé¢ */}
            {activeTab === 'stats' && (
              <div className="space-y-4 mb-20">
                <div className="bg-white rounded-lg shadow p-4">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold">å¹´åº¦ç›®æ ‡</h2>
                    <button
                      onClick={() => setShowSettingsForm(true)}
                      className="p-2 text-gray-600"
                    >
                      <Settings size={20} />
                    </button>
                  </div>
                  
                  <div className="mb-2">
                    <div className="flex justify-between text-sm mb-1">
                      <span>è¿›åº¦: {salesStats.progress.toFixed(1)}%</span>
                      <span>RM{salesStats.totalRevenue.toFixed(2)} / RM{settings.yearlyTarget.toFixed(2)}</span>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-4">
                      <div
                        className="bg-pink-500 h-4 rounded-full transition-all duration-500"
                        style={{ width: `${salesStats.progress}%` }}
                      />
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow p-4">
                  <h2 className="text-xl font-bold mb-4">é”€å”®ç»Ÿè®¡ ({currentYear}å¹´)</h2>
                  
                  <div className="grid grid-cols-2 gap-4 mb-4">
                    <div className="bg-blue-50 rounded-lg p-3">
                      <div className="text-sm text-blue-600 mb-1">å·²äº¤ä»˜è®¢å•</div>
                      <div className="text-2xl font-bold text-blue-700">{salesStats.orderCount}</div>
                    </div>
                    
                    <div className="bg-green-50 rounded-lg p-3">
                      <div className="text-sm text-green-600 mb-1">æ€»é”€å”®é¢</div>
                      <div className="text-2xl font-bold text-green-700">RM{salesStats.totalRevenue.toFixed(2)}</div>
                    </div>
                  </div>
                  
                  <div>
                    <h3 className="font-bold mb-2">äº§å“é”€é‡</h3>
                    {Object.keys(salesStats.productCount).length === 0 ? (
                      <p className="text-sm text-gray-500">æš‚æ— å·²äº¤ä»˜è®¢å•</p>
                    ) : (
                      <div className="space-y-2">
                        {Object.entries(salesStats.productCount)
                          .sort((a, b) => b[1] - a[1])
                          .map(([product, count]) => (
                            <div key={product} className="flex justify-between text-sm">
                              <span>{product}</span>
                              <span className="font-medium">{count} ä»½</span>
                            </div>
                          ))}
                      </div>
                    )}
                  </div>
                </div>

                {!isCurrentYearSettled && (
                  <button
                    onClick={settleYear}
                    className="w-full py-4 bg-purple-500 text-white rounded-lg font-bold text-lg shadow-lg"
                  >
                    ç»“ç®— {currentYear} å¹´åº¦
                  </button>
                )}
                
                {isCurrentYearSettled && (
                  <div className="bg-gray-100 rounded-lg p-4 text-center">
                    <p className="text-gray-600 font-medium">âœ“ {currentYear} å¹´åº¦å·²äº</p>
                    <p className="text-gray-600">
                      {formatDate(yearlyData[currentYear].settlementDate)} ç»“ç®—
                    </p>
                    <p className="text-sm text-gray-500 mt-2">
                      æœ€ç»ˆé”€å”®é¢: RM{yearlyData[currentYear].finalRevenue?.toFixed(2) || '0.00'}
                    </p>
                  </div>
                )}
              </div>
            )}
          </div>

          {/* å¹´ä»½é€‰æ‹©å™¨æ¨¡æ€æ¡† */}
          {showYearSelector && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white w-full max-w-md mx-4 rounded-lg p-6">
                <h2 className="text-xl font-bold mb-4">é€‰æ‹©å¹´ä»½</h2>
                <div className="space-y-2 max-h-96 overflow-y-auto">
                  {availableYears.map(year => (
                    <button
                      key={year}
                      onClick={() => selectYear(year)}
                      className={`w-full p-4 rounded-lg text-left ${
                        parseInt(year) === currentYear
                          ? 'bg-pink-500 text-white'
                          : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
                      }`}
                    >
                      <div className="flex justify-between items-center">
                        <span className="font-bold">{year} å¹´</span>
                        {yearlyData[year]?.settled && (
                          <span className="text-sm">âœ“ å·²ç»“ç®—</span>
                        )}
                      </div>
                    </button>
                  ))}
                </div>
                <button
                  onClick={() => setShowYearSelector(false)}
                  className="w-full mt-4 py-3 bg-gray-200 rounded-lg"
                >
                  å–æ¶ˆ
                </button>
              </div>
            </div>
          )}

          {/* è®¢å•è¡¨å•æ¨¡æ€æ¡† */}
          {showOrderForm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50">
              <div className="bg-white w-full sm:max-w-2xl sm:rounded-lg rounded-t-lg max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-white border-b px-4 py-3 flex justify-between items-center">
                  <h2 className="text-xl font-bold">{editingOrder ? 'ç¼–è¾‘è®¢å•' : 'æ–°å¢è®¢å•'}</h2>
                  <button onClick={resetOrderForm} className="text-gray-500">
                    <X size={24} />
                  </button>
                </div>

                <div className="p-4 space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">é€‰æ‹©å®¢æˆ·ï¼ˆå¯é€‰ï¼‰</label>
                    <div className="grid grid-cols-2 gap-2 mb-2">
                      {customers.map(customer => (
                        <button
                          key={customer.id}
                          onClick={() => selectCustomer(customer)}
                          className={`p-2 border rounded text-left text-sm ${
                            orderForm.customerId === customer.id ? 'border-pink-500 bg-pink-50' : 'border-gray-300'
                          }`}
                        >
                          <div className="font-medium">{customer.name}</div>
                          <div className="text-xs text-gray-600">{customer.phone}</div>
                        </button>
                      ))}
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">å®¢æˆ·å§“å *</label>
                    <input
                      type="text"
                      value={orderForm.customerName}
                      onChange={(e) => setOrderForm({ ...orderForm, customerName: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                      placeholder="è¾“å…¥å®¢æˆ·å§“å"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">ç”µè¯ *</label>
                    <input
                      type="tel"
                      value={orderForm.phone}
                      onChange={(e) => setOrderForm({ ...orderForm, phone: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                      placeholder="è¾“å…¥ç”µè¯å·ç "
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">è®¢å•æ˜ç»† *</label>
                    {orderForm.items.map((item, index) => (
                      <div key={index} className="mb-3 p-3 border border-gray-200 rounded">
                        <div className="space-y-2">
                          <select
                            value={item.productId}
                            onChange={(e) => updateOrderItem(index, 'productId', e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                          >
                            <option value="">é€‰æ‹©äº§å“</option>
                            {products.map(product => (
                              <option key={product.id} value={product.id}>
                                {product.name}
                              </option>
                            ))}
                          </select>
                          
                          {item.productId && (
                            <select
                              value={item.size}
                              onChange={(e) => updateOrderItem(index, 'size', e.target.value)}
                              className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                            >
                              <option value="">é€‰æ‹©å¤§å°</option>
                              {products.find(p => p.id === parseInt(item.productId))?.sizes.map((size, sIdx) => (
                                <option key={sIdx} value={size.name}>
                                  {size.name} - RM{size.price.toFixed(2)}
                                </option>
                              ))}
                            </select>
                          )}
                          
                          <div className="grid grid-cols-2 gap-2">
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">æ•°é‡</label>
                              <input
                                type="text"
                                value={item.quantity}
                                onChange={(e) => {
                                  const val = e.target.value;
                                  if (val === '' || /^\d+$/.test(val)) {
                                    updateOrderItem(index, 'quantity', val === '' ? '' : parseInt(val));
                                  }
                                }}
                                onBlur={(e) => {
                                  if (e.target.value === '' || parseInt(e.target.value) < 1) {
                                    updateOrderItem(index, 'quantity', 1);
                                  }
                                }}
                                placeholder="è¾“å…¥æ•°é‡"
                                className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                              />
                            </div>
                            <div>
                              <label className="block text-xs text-gray-600 mb-1">æ€»ä»· (è‡ªåŠ¨)</label>
                              <input
                                type="text"
                                value={
                                  item.price > 0 && item.quantity && parseInt(item.quantity) > 0
                                    ? `RM ${(item.price * parseInt(item.quantity)).toFixed(2)}`
                                    : item.price > 0 
                                      ? `RM ${item.price.toFixed(2)}`
                                      : 'è¯·é€‰æ‹©å¤§å°'
                                }
                                readOnly
                                className="w-full px-3 py-2 border border-gray-300 rounded bg-gray-50 text-gray-600 font-medium"
                              />
                            </div>
                          </div>
                          
                          {orderForm.items.length > 1 && (
                            <button
                              onClick={() => removeOrderItem(index)}
                              className="w-full py-2 text-red-600 text-sm"
                            >
                              <Trash2 size={16} className="inline mr-1" />
                              åˆ é™¤æ­¤é¡¹
                            </button>
                          )}
                        </div>
                      </div>
                    ))}
                    <button
                      onClick={addOrderItem}
                      className="text-pink-600 text-sm font-medium flex items-center gap-1"
                    >
                      <Plus size={16} />
                      æ·»åŠ æ›´å¤šäº§å“
                    </button>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">äº¤è´§æ—¥æœŸ *</label>
                    <input
                      type="date"
                      value={orderForm.deliveryDate}
                      onChange={(e) => setOrderForm({ ...orderForm, deliveryDate: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">å¤‡æ³¨</label>
                    <textarea
                      value={orderForm.notes}
                      onChange={(e) => setOrderForm({ ...orderForm, notes: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                      rows="3"
                      placeholder="ç‰¹æ®Šè¦æ±‚æˆ–å¤‡æ³¨"
                    />
                  </div>

                  <div className="flex gap-2 pt-4">
                    <button
                      onClick={resetOrderForm}
                      className="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium"
                    >
                      å–æ¶ˆ
                    </button>
                    <button
                      onClick={saveOrder}
                      className="flex-1 py-3 bg-pink-500 text-white rounded-lg font-medium"
                    >
                      ä¿å­˜è®¢å•
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* å®¢æˆ·è¡¨å•æ¨¡æ€æ¡† */}
          {showCustomerForm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50">
              <div className="bg-white w-full sm:max-w-lg sm:rounded-lg rounded-t-lg max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-white border-b px-4 py-3 flex justify-between items-center">
                  <h2 className="text-xl font-bold">{editingCustomer ? 'ç¼–è¾‘å®¢æˆ·' : 'æ–°å¢å®¢æˆ·'}</h2>
                  <button onClick={resetCustomerForm} className="text-gray-500">
                    <X size={24} />
                  </button>
                </div>

                <div className="p-4 space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">å®¢æˆ·å§“å *</label>
                    <input
                      type="text"
                      value={customerForm.name}
                      onChange={(e) => setCustomerForm({ ...customerForm, name: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">ç”µè¯ *</label>
                    <input
                      type="tel"
                      value={customerForm.phone}
                      onChange={(e) => setCustomerForm({ ...customerForm, phone: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">åœ°å€</label>
                    <input
                      type="text"
                      value={customerForm.address}
                      onChange={(e) => setCustomerForm({ ...customerForm, address: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">å¤‡æ³¨</label>
                    <textarea
                      value={customerForm.notes}
                      onChange={(e) => setCustomerForm({ ...customerForm, notes: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                      rows="3"
                    />
                  </div>

                  <div className="flex gap-2 pt-4">
                    <button
                      onClick={resetCustomerForm}
                      className="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium"
                    >
                      å–æ¶ˆ
                    </button>
                    <button
                      onClick={saveCustomer}
                      className="flex-1 py-3 bg-pink-500 text-white rounded-lg font-medium"
                    >
                      ä¿å­˜å®¢æˆ·
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* äº§å“è¡¨å•æ¨¡æ€æ¡† */}
          {showProductForm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50">
              <div className="bg-white w-full sm:max-w-lg sm:rounded-lg rounded-t-lg max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-white border-b px-4 py-3 flex justify-between items-center">
                  <h2 className="text-xl font-bold">{editingProduct ? 'ç¼–è¾‘äº§å“' : 'æ–°å¢äº§å“'}</h2>
                  <button onClick={resetProductForm} className="text-gray-500">
                    <X size={24} />
                  </button>
                </div>

                <div className="p-4 space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">äº§å“åç§° *</label>
                    <input
                      type="text"
                      value={productForm.name}
                      onChange={(e) => setProductForm({ ...productForm, name: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                      placeholder="ä¾‹å¦‚ï¼šå·§å…‹åŠ›æ›²å¥‡"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">å¤§å°å’Œä»·æ ¼ *</label>
                    {productForm.sizes.map((size, index) => (
                      <div key={index} className="flex gap-2 mb-2">
                        <input
                          type="text"
                          value={size.name}
                          onChange={(e) => updateProductSize(index, 'name', e.target.value)}
                          placeholder="å¤§å°åç§°"
                          className="flex-1 px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                        />
                        <input
                          type="number"
                          value={size.price}
                          onChange={(e) => updateProductSize(index, 'price', e.target.value)}
                          step="0.01"
                          placeholder="ä»·æ ¼"
                          className="w-24 px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                        />
                        {productForm.sizes.length > 1 && (
                          <button
                            onClick={() => removeProductSize(index)}
                            className="p-2 text-red-600"
                          >
                            <Trash2 size={20} />
                          </button>
                        )}
                      </div>
                    ))}
                    <button
                      onClick={addProductSize}
                      className="text-pink-600 text-sm font-medium flex items-center gap-1"
                    >
                      <Plus size={16} />
                      æ·»åŠ å¤§å°é€‰é¡¹
                    </button>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">å•ä½</label>
                    <input
                      type="text"
                      value={productForm.unit}
                      onChange={(e) => setProductForm({ ...productForm, unit: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                      placeholder="ç›’/åŒ…/ä¸ª"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">æè¿°</label>
                    <textarea
                      value={productForm.description}
                      onChange={(e) => setProductForm({ ...productForm, description: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                      rows="3"
                      placeholder="äº§å“æè¿°æˆ–ç‰¹è‰²"
                    />
                  </div>

                  <div className="flex gap-2 pt-4">
                    <button
                      onClick={resetProductForm}
                      className="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium"
                    >
                      å–æ¶ˆ
                    </button>
                    <button
                      onClick={saveProduct}
                      className="flex-1 py-3 bg-pink-500 text-white rounded-lg font-medium"
                    >
                      ä¿å­˜äº§å“
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* è®¾ç½®è¡¨å•æ¨¡æ€æ¡† */}
          {showSettingsForm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50">
              <div className="bg-white w-full sm:max-w-lg sm:rounded-lg rounded-t-lg max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-white border-b px-4 py-3 flex justify-between items-center">
                  <h2 className="text-xl font-bold">è®¾ç½®å¹´åº¦ç›®æ ‡</h2>
                  <button onClick={() => setShowSettingsForm(false)} className="text-gray-500">
                    <X size={24} />
                  </button>
                </div>

                <div className="p-4 space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">{currentYear} å¹´é”€å”®ç›®æ ‡ (RM)</label>
                    <input
                      type="text"
                      value={settings.yearlyTarget}
                      onChange={(e) => {
                        const val = e.target.value;
                        // å…è®¸ç©ºå­—ç¬¦ä¸²ã€çº¯æ•°å­—ã€æˆ–æ•°å­—å¸¦å°æ•°ç‚¹
                        if (val === '' || /^\d*\.?\d*$/.test(val)) {
                          setSettings({ ...settings, yearlyTarget: val === '' ? 0 : parseFloat(val) || 0 });
                        }
                      }}
                      className="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-pink-500"
                      placeholder="è¾“å…¥ç›®æ ‡é‡‘é¢ï¼Œä¾‹å¦‚ï¼š10000"
                    />
                    <p className="text-xs text-gray-500 mt-1">å½“å‰ç›®æ ‡: RM {settings.yearlyTarget.toFixed(2)}</p>
                  </div>

                  <div className="flex gap-2 pt-4">
                    <button
                      onClick={() => setShowSettingsForm(false)}
                      className="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium"
                    >
                      å–æ¶ˆ
                    </button>
                    <button
                      onClick={() => {
                        setShowSettingsForm(false);
                        alert('è®¾ç½®å·²ä¿å­˜ï¼');
                      }}
                      className="flex-1 py-3 bg-pink-500 text-white rounded-lg font-medium"
                    >
                      ä¿å­˜
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // æ¸²æŸ“åº”ç”¨
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<CookieOrderManager />);
  </script>

  <!-- æ³¨å†Œ Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration);
          })
          .catch(error => {
            console.log('Service Worker æ³¨å†Œå¤±è´¥:', error);
          });
      });
    }
  </script>
</body>
</html>