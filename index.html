<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#ec4899">
  <title>é¥¼å¹²è®¢å•ç®¡ç†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; overscroll-behavior-y: contain; }
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
    }
  </style>
</head>
<body>
  <div id="root">
    <div class="min-h-screen flex items-center justify-center bg-pink-50">
      <div class="text-center">
        <div class="text-6xl mb-4 animate-bounce">ğŸª</div>
        <p class="text-gray-600">æ­£åœ¨åŠ è½½ Firebase...</p>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, onSnapshot, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // ğŸ”¥ Firebase é…ç½® - è¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„é…ç½®ï¼
    const firebaseConfig = {
      apiKey: "AIzaSyD5JPfaWYueNRS-KCbYsZrGech3ZzLOhfY",
      authDomain: "cookie-order-management.firebaseapp.com",
      projectId: "cookie-order-management",
      storageBucket: "cookie-order-management.firebasestorage.app",
      messagingSenderId: "1007966950255",
      appId: "1:1007966950255:web:dbd1670df9099ef687ce9a",
      measurementId: "G-7NF697073Z"
    };

    try {
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // å¯ç”¨ç¦»çº¿æ”¯æŒ
      enableIndexedDbPersistence(db).catch((err) => {
        console.log('ç¦»çº¿æŒä¹…åŒ–:', err.code);
      });

      // æš´éœ²åˆ°å…¨å±€
      window.firebase = {
        app,
        auth,
        db,
        GoogleAuthProvider,
        signInWithPopup,
        signOut,
        onAuthStateChanged,
        collection,
        doc,
        setDoc,
        getDoc,
        getDocs,
        deleteDoc,
        query,
        onSnapshot
      };

      console.log('âœ… Firebase åˆå§‹åŒ–æˆåŠŸ');
      window.dispatchEvent(new Event('firebaseReady'));
    } catch (error) {
      console.error('âŒ Firebase åˆå§‹åŒ–å¤±è´¥:', error);
      document.getElementById('root').innerHTML = `
        <div class="min-h-screen flex items-center justify-center bg-red-50 p-4">
          <div class="bg-white p-6 rounded-lg shadow-xl max-w-md">
            <h2 class="text-xl font-bold text-red-600 mb-4">Firebase åˆå§‹åŒ–å¤±è´¥</h2>
            <p class="text-gray-700 mb-4">è¯·æ£€æŸ¥ Firebase é…ç½®æ˜¯å¦æ­£ç¡®ã€‚</p>
            <pre class="bg-gray-100 p-3 rounded text-xs overflow-auto">${error.message}</pre>
            <button onclick="location.reload()" class="mt-4 w-full bg-red-500 text-white py-2 rounded">
              é‡æ–°åŠ è½½
            </button>
          </div>
        </div>
      `;
    }
  </script>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- ä¸»åº”ç”¨ -->
  <script type="text/babel">
    const { useState, useEffect } = React;

    // ç­‰å¾… Firebase å‡†å¤‡å¥½
    const useFirebaseReady = () => {
      const [ready, setReady] = useState(false);

      useEffect(() => {
        if (window.firebase) {
          setReady(true);
        } else {
          const handler = () => setReady(true);
          window.addEventListener('firebaseReady', handler);
          return () => window.removeEventListener('firebaseReady', handler);
        }
      }, []);

      return ready;
    };

    // è®¤è¯çŠ¶æ€
    const useAuth = () => {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const ready = useFirebaseReady();

      useEffect(() => {
        if (!ready) return;
        
        const { auth, onAuthStateChanged } = window.firebase;
        const unsubscribe = onAuthStateChanged(auth, (user) => {
          setUser(user);
          setLoading(false);
        });

        return unsubscribe;
      }, [ready]);

      const signIn = async () => {
        const { auth, GoogleAuthProvider, signInWithPopup } = window.firebase;
        try {
          await signInWithPopup(auth, new GoogleAuthProvider());
        } catch (error) {
          alert('ç™»å½•å¤±è´¥: ' + error.message);
        }
      };

      const signOut = async () => {
        const { auth, signOut: firebaseSignOut } = window.firebase;
        await firebaseSignOut(auth);
      };

      return { user, loading, signIn, signOut, ready };
    };

    // ç™»å½•é¡µé¢
    const LoginPage = ({ onSignIn }) => (
      <div className="login-container">
        <div className="bg-white p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
          <div className="text-center mb-8">
            <div className="text-6xl mb-4">ğŸª</div>
            <h1 className="text-3xl font-bold text-gray-800 mb-2">é¥¼å¹²è®¢å•ç®¡ç†</h1>
            <p className="text-gray-600">å¦ˆå¦ˆçš„æ‰‹å·¥é¥¼å¹²è®¢å•å°åŠ©æ‰‹</p>
          </div>
          
          <button
            onClick={onSignIn}
            className="w-full bg-white border-2 border-gray-300 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-50 transition-colors flex items-center justify-center gap-3"
          >
            <span>ğŸ”</span>
            ä½¿ç”¨ Google è´¦å·ç™»å½•
          </button>
          
          <p className="text-xs text-gray-500 text-center mt-6">
            ç™»å½•åï¼Œä½ çš„æ•°æ®å°†å®‰å…¨åœ°ä¿å­˜åœ¨äº‘ç«¯<br />
            æ”¯æŒå¤šè®¾å¤‡åŒæ­¥å’Œç¦»çº¿ä½¿ç”¨
          </p>
        </div>
      </div>
    );

    // ä¸»åº”ç”¨
    const App = () => {
      const { user, loading, signIn, signOut, ready } = useAuth();

      if (!ready || loading) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-pink-50">
            <div className="text-center">
              <div className="text-6xl mb-4 animate-bounce">ğŸª</div>
              <p className="text-gray-600">åŠ è½½ä¸­...</p>
            </div>
          </div>
        );
      }

      if (!user) {
        return <LoginPage onSignIn={signIn} />;
      }

      return (
        <div className="min-h-screen bg-gray-50">
          <div className="bg-gradient-to-r from-pink-500 to-pink-600 text-white p-4">
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-3">
                <span className="text-2xl">ğŸª</span>
                <div>
                  <h1 className="text-xl font-bold">é¥¼å¹²è®¢å•ç®¡ç†</h1>
                  <p className="text-xs opacity-90">{user.email}</p>
                </div>
              </div>
              <button
                onClick={signOut}
                className="bg-white bg-opacity-20 px-4 py-2 rounded-lg text-sm"
              >
                ç™»å‡º
              </button>
            </div>
          </div>

          <div className="p-4">
            <div className="bg-white p-6 rounded-lg shadow-xl text-center">
              <div className="text-6xl mb-4">ğŸ‰</div>
              <h2 className="text-2xl font-bold mb-2">Firebase è¿æ¥æˆåŠŸï¼</h2>
              <p className="text-gray-600 mb-4">
                æ­å–œï¼ä½ çš„åº”ç”¨å·²æˆåŠŸè¿æ¥åˆ° Firebaseã€‚
              </p>
              <div className="bg-green-50 border border-green-200 rounded-lg p-4 text-left">
                <h3 className="font-bold text-green-800 mb-2">âœ… å·²å®Œæˆ:</h3>
                <ul className="text-sm text-green-700 space-y-1">
                  <li>â€¢ Firebase åˆå§‹åŒ–æˆåŠŸ</li>
                  <li>â€¢ Google è´¦å·ç™»å½•æˆåŠŸ</li>
                  <li>â€¢ ç”¨æˆ·è®¤è¯å·¥ä½œæ­£å¸¸</li>
                  <li>â€¢ å‡†å¤‡å¥½é›†æˆå®Œæ•´åŠŸèƒ½</li>
                </ul>
              </div>
              <div className="mt-4 text-sm text-gray-600">
                <p>ç”¨æˆ· ID: {user.uid.substring(0, 8)}...</p>
                <p>é‚®ç®±: {user.email}</p>
              </div>
              <div className="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p className="text-sm text-blue-800">
                  ğŸ¯ ä¸‹ä¸€æ­¥ï¼šå°†å®Œæ•´çš„è®¢å•ç®¡ç†åŠŸèƒ½é›†æˆåˆ°è¿™ä¸ªæ¡†æ¶ä¸­
                </p>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // æ¸²æŸ“
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log('âœ… Service Worker æ³¨å†ŒæˆåŠŸ'))
        .catch((e) => console.log('Service Worker æ³¨å†Œå¤±è´¥:', e));
    }
  </script>
</body>
</html>
