<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#ec4899">
  <title>é¥¼å¹²è®¢å•ç®¡ç†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; overscroll-behavior-y: contain; }
    ::-webkit-scrollbar { width: 0px; background: transparent; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-day { aspect-ratio: 1; min-height: 60px; }
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, onSnapshot, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD5JPfaWYueNRS-KCbYsZrGech3ZzLOhfY",
      authDomain: "cookie-order-management.firebaseapp.com",
      projectId: "cookie-order-management",
      storageBucket: "cookie-order-management.firebasestorage.app",
      messagingSenderId: "1007966950255",
      appId: "1:1007966950255:web:dbd1670df9099ef687ce9a",
      measurementId: "G-7NF697073Z"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    enableIndexedDbPersistence(db).catch((err) => {
      console.log('ç¦»çº¿æŒä¹…åŒ–:', err.code);
    });

    window.firebase = {
      app, auth, db,
      GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged,
      collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, onSnapshot
    };

    window.dispatchEvent(new Event('firebaseReady'));
  </script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    // å›¾æ ‡
    const Icon = ({ children, size = 20 }) => (
      <span style={{ display: 'inline-block', width: size, height: size, lineHeight: `${size}px` }}>
        {children}
      </span>
    );

    const Icons = {
      Calendar: (p) => <Icon {...p}>ğŸ“…</Icon>,
      Package: (p) => <Icon {...p}>ğŸ“¦</Icon>,
      Users: (p) => <Icon {...p}>ğŸ‘¥</Icon>,
      Plus: (p) => <Icon {...p}>â•</Icon>,
      Search: (p) => <Icon {...p}>ğŸ”</Icon>,
      X: (p) => <Icon {...p}>âœ–ï¸</Icon>,
      Edit: (p) => <Icon {...p}>âœï¸</Icon>,
      Trash: (p) => <Icon {...p}>ğŸ—‘ï¸</Icon>,
      Check: (p) => <Icon {...p}>âœ“</Icon>,
      Settings: (p) => <Icon {...p}>âš™ï¸</Icon>,
      ChevronLeft: (p) => <Icon {...p}>â—€</Icon>,
      ChevronRight: (p) => <Icon {...p}>â–¶</Icon>,
      Filter: (p) => <Icon {...p}>ğŸ”½</Icon>,
      LogOut: (p) => <Icon {...p}>ğŸšª</Icon>,
    };

    // Firebase Ready Hook
    const useFirebaseReady = () => {
      const [ready, setReady] = useState(false);
      useEffect(() => {
        if (window.firebase) {
          setReady(true);
        } else {
          const handler = () => setReady(true);
          window.addEventListener('firebaseReady', handler);
          return () => window.removeEventListener('firebaseReady', handler);
        }
      }, []);
      return ready;
    };

    // è®¤è¯
    const useAuth = () => {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const ready = useFirebaseReady();

      useEffect(() => {
        if (!ready) return;
        const { auth, onAuthStateChanged } = window.firebase;
        return onAuthStateChanged(auth, (user) => {
          setUser(user);
          setLoading(false);
        });
      }, [ready]);

      const signIn = async () => {
        const { auth, GoogleAuthProvider, signInWithPopup } = window.firebase;
        try {
          await signInWithPopup(auth, new GoogleAuthProvider());
        } catch (error) {
          alert('ç™»å½•å¤±è´¥: ' + error.message);
        }
      };

      const signOutUser = async () => {
        const { auth, signOut } = window.firebase;
        await signOut(auth);
      };

      return { user, loading, signIn, signOut: signOutUser, ready };
    };

    // æ•°æ®ç®¡ç†
    const useData = (user) => {
      const [orders, setOrders] = useState([]);
      const [customers, setCustomers] = useState([]);
      const [products, setProducts] = useState([]);
      const [yearlyData, setYearlyData] = useState({});
      const [settings, setSettings] = useState({ yearlyTarget: 0 });
      const [currentYear, setCurrentYear] = useState(null);

      const { db, collection, doc, setDoc, getDoc, onSnapshot } = window.firebase || {};

      // åˆå§‹åŒ–å¹´ä»½
      useEffect(() => {
        if (!user || !db) return;

        const initYear = async () => {
          try {
            const ref = doc(db, 'users', user.uid, 'data', 'yearlyData');
            const snapshot = await getDoc(ref);
            
            let data = {};
            if (snapshot.exists()) {
              data = snapshot.data();
            } else {
              const year = new Date().getFullYear();
              data = { [year]: { settled: false } };
              await setDoc(ref, data);
            }
            
            setYearlyData(data);
            const years = Object.keys(data).sort((a, b) => b - a);
            const thisYear = new Date().getFullYear();
            
            setCurrentYear(data[thisYear] ? thisYear : (years.length > 0 ? parseInt(years[0]) : thisYear));
          } catch (error) {
            console.error('åˆå§‹åŒ–å¤±è´¥:', error);
          }
        };

        initYear();
      }, [user, db]);

      // åŠ è½½è®¾ç½®
      useEffect(() => {
        if (!user || !db) return;

        const loadSettings = async () => {
          try {
            const ref = doc(db, 'users', user.uid, 'data', 'settings');
            const snapshot = await getDoc(ref);
            if (snapshot.exists()) {
              setSettings(snapshot.data());
            }
          } catch (error) {
            console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
          }
        };

        loadSettings();
      }, [user, db]);

      // è®¢å•
      useEffect(() => {
        if (!user || !db || !currentYear) return;

        const ref = collection(db, 'users', user.uid, 'orders', String(currentYear), 'items');
        return onSnapshot(ref, (snapshot) => {
          const data = [];
          snapshot.forEach((doc) => data.push({ id: doc.id, ...doc.data() }));
          setOrders(data);
        });
      }, [user, db, currentYear]);

      // å®¢æˆ·
      useEffect(() => {
        if (!user || !db) return;

        const ref = collection(db, 'users', user.uid, 'customers');
        return onSnapshot(ref, (snapshot) => {
          const data = [];
          snapshot.forEach((doc) => data.push({ id: doc.id, ...doc.data() }));
          setCustomers(data);
        });
      }, [user, db]);

      // äº§å“
      useEffect(() => {
        if (!user || !db) return;

        const ref = collection(db, 'users', user.uid, 'products');
        return onSnapshot(ref, (snapshot) => {
          const data = [];
          snapshot.forEach((doc) => data.push({ id: doc.id, ...doc.data() }));
          setProducts(data);
        });
      }, [user, db]);

      // ä¿å­˜å‡½æ•°
      const saveOrder = async (order) => {
        if (!user || !currentYear) return;
        const id = order.id || `order_${Date.now()}`;
        const ref = doc(db, 'users', user.uid, 'orders', String(currentYear), 'items', id);
        await setDoc(ref, { ...order, id, updatedAt: new Date().toISOString() });
      };

      const deleteOrder = async (orderId) => {
        if (!user || !currentYear) return;
        const { deleteDoc } = window.firebase;
        const ref = doc(db, 'users', user.uid, 'orders', String(currentYear), 'items', orderId);
        await deleteDoc(ref);
      };

      const saveCustomer = async (customer) => {
        if (!user) return;
        const id = customer.id || `customer_${Date.now()}`;
        const ref = doc(db, 'users', user.uid, 'customers', id);
        await setDoc(ref, { ...customer, id, updatedAt: new Date().toISOString() });
      };

      const deleteCustomer = async (customerId) => {
        if (!user) return;
        const { deleteDoc } = window.firebase;
        const ref = doc(db, 'users', user.uid, 'customers', customerId);
        await deleteDoc(ref);
      };

      const saveProduct = async (product) => {
        if (!user) return;
        const id = product.id || `product_${Date.now()}`;
        const ref = doc(db, 'users', user.uid, 'products', id);
        await setDoc(ref, { ...product, id, updatedAt: new Date().toISOString() });
      };

      const deleteProduct = async (productId) => {
        if (!user) return;
        const { deleteDoc } = window.firebase;
        const ref = doc(db, 'users', user.uid, 'products', productId);
        await deleteDoc(ref);
      };

      const saveYearlyData = async (data) => {
        if (!user) return;
        const ref = doc(db, 'users', user.uid, 'data', 'yearlyData');
        await setDoc(ref, data);
      };

      const saveSettings = async (newSettings) => {
        if (!user) return;
        const ref = doc(db, 'users', user.uid, 'data', 'settings');
        await setDoc(ref, newSettings);
        setSettings(newSettings);
      };

      return {
        orders, customers, products, yearlyData, settings, currentYear,
        setCurrentYear, saveOrder, deleteOrder, saveCustomer, deleteCustomer,
        saveProduct, deleteProduct, saveYearlyData, saveSettings, setYearlyData
      };
    };

    // ç™»å½•é¡µ
    const LoginPage = ({ onSignIn }) => (
      <div className="login-container">
        <div className="bg-white p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
          <div className="text-center mb-8">
            <div className="text-6xl mb-4">ğŸª</div>
            <h1 className="text-3xl font-bold text-gray-800 mb-2">é¥¼å¹²è®¢å•ç®¡ç†</h1>
            <p className="text-gray-600">å¦ˆå¦ˆçš„æ‰‹å·¥é¥¼å¹²è®¢å•å°åŠ©æ‰‹</p>
          </div>
          <button
            onClick={onSignIn}
            className="w-full bg-white border-2 border-gray-300 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-50 flex items-center justify-center gap-3"
          >
            <span>ğŸ”</span>
            ä½¿ç”¨ Google è´¦å·ç™»å½•
          </button>
          <p className="text-xs text-gray-500 text-center mt-6">
            ç™»å½•åï¼Œæ•°æ®å°†å®‰å…¨ä¿å­˜åœ¨äº‘ç«¯
          </p>
        </div>
      </div>
    );

    // ä¸»åº”ç”¨ - ç®€åŒ–ç‰ˆï¼ˆå…ˆç¡®ä¿èƒ½è¿è¡Œï¼‰
    const App = () => {
      const { user, loading, signIn, signOut, ready } = useAuth();
      const data = useData(user);
      
      const [activeTab, setActiveTab] = useState('orders');
      const [searchTerm, setSearchTerm] = useState('');

      if (!ready || loading) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-pink-50">
            <div className="text-center">
              <div className="text-6xl mb-4 animate-bounce">ğŸª</div>
              <p className="text-gray-600">åŠ è½½ä¸­...</p>
            </div>
          </div>
        );
      }

      if (!user) {
        return <LoginPage onSignIn={signIn} />;
      }

      // ç®€å•è¿‡æ»¤ - ä¸ä½¿ç”¨ useMemo
      const filteredOrders = data.orders.filter(order => {
        if (!searchTerm) return true;
        return (
          order.customerName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
          order.customerPhone?.includes(searchTerm) ||
          order.id?.includes(searchTerm)
        );
      }).sort((a, b) => {
        if (!a.deliveryDate) return 1;
        if (!b.deliveryDate) return -1;
        return new Date(a.deliveryDate) - new Date(b.deliveryDate);
      });

      // ç»Ÿè®¡
      const stats = {
        total: data.orders.length,
        pending: data.orders.filter(o => o.status === 'pending').length,
        completed: data.orders.filter(o => o.status === 'completed').length,
        revenue: data.orders.filter(o => o.status === 'completed').reduce((sum, o) => sum + (o.totalAmount || 0), 0)
      };

      return (
        <div className="min-h-screen bg-gray-50 pb-20">
          {/* é¡¶éƒ¨ */}
          <div className="bg-gradient-to-r from-pink-500 to-pink-600 text-white p-4 sticky top-0 z-10">
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-3">
                <span className="text-2xl">ğŸª</span>
                <div>
                  <h1 className="text-xl font-bold">é¥¼å¹²è®¢å•ç®¡ç†</h1>
                  <p className="text-xs opacity-90">{user.email}</p>
                </div>
              </div>
              <button
                onClick={signOut}
                className="bg-white bg-opacity-20 p-2 rounded-lg"
              >
                <Icons.LogOut size={20} />
              </button>
            </div>
          </div>

          <div className="p-4">
            {/* ç»Ÿè®¡å¡ç‰‡ */}
            <div className="grid grid-cols-2 gap-3 mb-4">
              <div className="bg-white p-4 rounded-lg shadow">
                <div className="text-gray-600 text-sm mb-1">æ€»è®¢å•</div>
                <div className="text-2xl font-bold text-pink-600">{stats.total}</div>
              </div>
              <div className="bg-white p-4 rounded-lg shadow">
                <div className="text-gray-600 text-sm mb-1">å¾…å¤„ç†</div>
                <div className="text-2xl font-bold text-orange-600">{stats.pending}</div>
              </div>
              <div className="bg-white p-4 rounded-lg shadow">
                <div className="text-gray-600 text-sm mb-1">å·²å®Œæˆ</div>
                <div className="text-2xl font-bold text-green-600">{stats.completed}</div>
              </div>
              <div className="bg-white p-4 rounded-lg shadow">
                <div className="text-gray-600 text-sm mb-1">è¥ä¸šé¢</div>
                <div className="text-2xl font-bold text-blue-600">Â¥{stats.revenue.toFixed(2)}</div>
              </div>
            </div>

            {/* æœç´¢ */}
            <div className="mb-4">
              <div className="relative">
                <Icons.Search className="absolute left-3 top-3 text-gray-400" size={20} />
                <input
                  type="text"
                  placeholder="æœç´¢è®¢å•..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg"
                />
              </div>
            </div>

            {/* è®¢å•åˆ—è¡¨ */}
            <div className="space-y-3">
              {filteredOrders.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <Icons.Package size={48} className="mx-auto mb-2 opacity-50" />
                  <p>è¿˜æ²¡æœ‰è®¢å•</p>
                </div>
              ) : (
                filteredOrders.map(order => (
                  <div key={order.id} className="bg-white p-4 rounded-lg shadow">
                    <div className="flex justify-between items-start mb-2">
                      <div className="flex-1">
                        <div className="font-bold text-lg">{order.customerName}</div>
                        <div className="text-sm text-gray-600">{order.customerPhone}</div>
                      </div>
                    </div>
                    <div className="space-y-1 text-sm mb-2">
                      {order.products?.map((product, idx) => (
                        <div key={idx} className="text-gray-700">
                          {product.name} ({product.size}) x {product.quantity} - Â¥{(product.price * product.quantity).toFixed(2)}
                        </div>
                      ))}
                    </div>
                    <div className="flex justify-between items-center pt-2 border-t">
                      <div className="text-sm text-gray-600">
                        äº¤ä»˜: {order.deliveryDate || 'æœªè®¾ç½®'}
                      </div>
                      <div className="flex items-center gap-2">
                        <span className={`text-xs px-2 py-1 rounded ${
                          order.status === 'pending' ? 'bg-orange-100 text-orange-700' :
                          order.status === 'completed' ? 'bg-green-100 text-green-700' :
                          'bg-gray-100 text-gray-700'
                        }`}>
                          {order.status === 'pending' ? 'å¾…å¤„ç†' :
                           order.status === 'completed' ? 'å·²å®Œæˆ' : 'å…¶ä»–'}
                        </span>
                        <span className="font-bold text-pink-600">Â¥{order.totalAmount?.toFixed(2) || '0.00'}</span>
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>

          {/* åº•éƒ¨å¯¼èˆª */}
          <div className="fixed bottom-0 left-0 right-0 bg-white border-t">
            <div className="flex justify-around py-2">
              <button
                onClick={() => setActiveTab('orders')}
                className={`flex flex-col items-center py-2 px-4 ${
                  activeTab === 'orders' ? 'text-pink-600' : 'text-gray-600'
                }`}
              >
                <Icons.Package size={24} />
                <span className="text-xs mt-1">è®¢å•</span>
              </button>
              <button className="flex flex-col items-center py-2 px-4 text-gray-400">
                <Icons.Users size={24} />
                <span className="text-xs mt-1">å®¢æˆ·</span>
              </button>
              <button className="flex flex-col items-center py-2 px-4 text-gray-400">
                <Icons.Settings size={24} />
                <span className="text-xs mt-1">è®¾ç½®</span>
              </button>
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
