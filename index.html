<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#ec4899">
  <link rel="manifest" href="/manifest.json">
  <title>é¥¼å¹²è®¢å•ç®¡ç†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; overscroll-behavior-y: contain; }
    ::-webkit-scrollbar { width: 0px; background: transparent; }
    .calendar-grid { 
      display: grid; 
      grid-template-columns: repeat(7, 1fr); 
      gap: 4px;
    }
    .calendar-day { 
      aspect-ratio: 1; 
      min-height: 60px; 
      cursor: pointer;
      overflow: hidden;
    }
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
    }
    .progress-bar {
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ec4899, #f472b6);
      transition: width 0.3s ease;
    }
    /* ä¿®å¤æ—¥å†å¤´éƒ¨å¯¹é½ */
    .calendar-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .calendar-header > div {
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, where, onSnapshot, enableIndexedDbPersistence, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD5JPfaWYueNRS-KCbYsZrGech3ZzLOhfY",
      authDomain: "cookie-order-management.firebaseapp.com",
      projectId: "cookie-order-management",
      storageBucket: "cookie-order-management.firebasestorage.app",
      messagingSenderId: "1007966950255",
      appId: "1:1007966950255:web:dbd1670df9099ef687ce9a",
      measurementId: "G-7NF697073Z"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    enableIndexedDbPersistence(db).catch(() => {});

    window.firebase = {
      app, auth, db,
      GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged,
      collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, where, onSnapshot, writeBatch
    };

    window.dispatchEvent(new Event('firebaseReady'));
  </script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    const Icon = ({ children, size = 20 }) => (
      <span style={{ display: 'inline-block', width: size, height: size, lineHeight: `${size}px` }}>
        {children}
      </span>
    );

    const Icons = {
      Home: (p) => <Icon {...p}>ğŸ </Icon>,
      Calendar: (p) => <Icon {...p}>ğŸ“…</Icon>,
      Package: (p) => <Icon {...p}>ğŸ“¦</Icon>,
      Users: (p) => <Icon {...p}>ğŸ‘¥</Icon>,
      Plus: (p) => <Icon {...p}>â•</Icon>,
      Search: (p) => <Icon {...p}>ğŸ”</Icon>,
      X: (p) => <Icon {...p}>âœ–ï¸</Icon>,
      Edit: (p) => <Icon {...p}>âœï¸</Icon>,
      Trash: (p) => <Icon {...p}>ğŸ—‘ï¸</Icon>,
      Check: (p) => <Icon {...p}>âœ“</Icon>,
      Settings: (p) => <Icon {...p}>âš™ï¸</Icon>,
      ChevronLeft: (p) => <Icon {...p}>â—€</Icon>,
      ChevronRight: (p) => <Icon {...p}>â–¶</Icon>,
      Filter: (p) => <Icon {...p}>ğŸ”½</Icon>,
      LogOut: (p) => <Icon {...p}>ğŸšª</Icon>,
      TrendingUp: (p) => <Icon {...p}>ğŸ“ˆ</Icon>,
    };

    const useFirebaseReady = () => {
      const [ready, setReady] = useState(false);
      useEffect(() => {
        if (window.firebase) {
          setReady(true);
        } else {
          const h = () => setReady(true);
          window.addEventListener('firebaseReady', h);
          return () => window.removeEventListener('firebaseReady', h);
        }
      }, []);
      return ready;
    };

    const useAuth = () => {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const ready = useFirebaseReady();

      useEffect(() => {
        if (!ready) return;
        
        const { auth, onAuthStateChanged } = window.firebase;
        
        const unsubscribe = onAuthStateChanged(auth, (u) => {
          console.log('Auth state changed:', u ? 'logged in' : 'logged out');
          setUser(u);
          setLoading(false);
        });

        return () => unsubscribe();
      }, [ready]);

      const signIn = async () => {
        try {
          const { auth, GoogleAuthProvider, signInWithPopup } = window.firebase;
          const provider = new GoogleAuthProvider();
          await signInWithPopup(auth, provider);
        } catch (e) {
          console.error('Login error:', e);
          alert('ç™»å½•å¤±è´¥: ' + e.message);
        }
      };

      const signOutUser = async () => {
        try {
          await window.firebase.signOut(window.firebase.auth);
        } catch (e) {
          console.error('Logout error:', e);
        }
      };

      return { user, loading, signIn, signOut: signOutUser, ready };
    };

    const useData = (user) => {
      const [orders, setOrders] = useState([]);
      const [customers, setCustomers] = useState([]);
      const [products, setProducts] = useState([]);
      const [yearlyData, setYearlyData] = useState({});
      const [settings, setSettings] = useState({ yearlyTarget: 0 });
      const [currentYear, setCurrentYear] = useState(null);

      const { db, collection, doc, setDoc, getDoc, onSnapshot, query, where, writeBatch } = window.firebase || {};

      useEffect(() => {
        if (!user || !db) return;
        
        (async () => {
          try {
            const ref = doc(db, 'users', user.uid, 'data', 'yearlyData');
            const snap = await getDoc(ref);
            let data = {};
            
            if (snap.exists()) {
              data = snap.data();
            } else {
              const y = new Date().getFullYear();
              data = { [y]: { settled: false } };
              await setDoc(ref, data);
            }
            
            setYearlyData(data);
            const years = Object.keys(data).sort((a, b) => b - a);
            const thisYear = new Date().getFullYear();
            setCurrentYear(data[thisYear] ? thisYear : (years.length > 0 ? parseInt(years[0]) : thisYear));
          } catch (e) {
            console.error('Init year error:', e);
          }
        })();
      }, [user, db]);

      useEffect(() => {
        if (!user || !db) return;
        
        (async () => {
          try {
            const ref = doc(db, 'users', user.uid, 'data', 'settings');
            const snap = await getDoc(ref);
            if (snap.exists()) setSettings(snap.data());
          } catch (e) {
            console.error('Load settings error:', e);
          }
        })();
      }, [user, db]);

      useEffect(() => {
        if (!user || !db || !currentYear) return;
        
        const ref = collection(db, 'users', user.uid, 'orders', String(currentYear), 'items');
        const unsubscribe = onSnapshot(ref, (snap) => {
          const data = [];
          snap.forEach((d) => data.push({ id: d.id, ...d.data() }));
          setOrders(data);
        }, (error) => {
          console.error('Orders snapshot error:', error);
        });

        return () => unsubscribe();
      }, [user, db, currentYear]);

      useEffect(() => {
        if (!user || !db) return;
        
        const ref = collection(db, 'users', user.uid, 'customers');
        const unsubscribe = onSnapshot(ref, (snap) => {
          const data = [];
          snap.forEach((d) => data.push({ id: d.id, ...d.data() }));
          setCustomers(data);
        }, (error) => {
          console.error('Customers snapshot error:', error);
        });

        return () => unsubscribe();
      }, [user, db]);

      useEffect(() => {
        if (!user || !db) return;
        
        const ref = collection(db, 'users', user.uid, 'products');
        const unsubscribe = onSnapshot(ref, (snap) => {
          const data = [];
          snap.forEach((d) => data.push({ id: d.id, ...d.data() }));
          setProducts(data);
        }, (error) => {
          console.error('Products snapshot error:', error);
        });

        return () => unsubscribe();
      }, [user, db]);

      const saveOrder = async (order) => {
        if (!user || !currentYear) return;
        const id = order.id || `order_${Date.now()}`;
        const ref = doc(db, 'users', user.uid, 'orders', String(currentYear), 'items', id);
        
        // ä¿å­˜å®¢æˆ·å¼•ç”¨ä¿¡æ¯ï¼ˆç”¨äºåŒæ­¥æ›´æ–°ï¼‰
        const customer = customers.find(c => c.phone === order.customerPhone);
        const orderData = {
          ...order,
          id,
          customerId: customer?.id || null,
          updatedAt: new Date().toISOString()
        };
        
        await setDoc(ref, orderData);
      };

      const deleteOrder = async (id) => {
        if (!user || !currentYear) return;
        const ref = doc(db, 'users', user.uid, 'orders', String(currentYear), 'items', id);
        await window.firebase.deleteDoc(ref);
      };

      const saveCustomer = async (customer) => {
        if (!user) return;
        const id = customer.id || `customer_${Date.now()}`;
        const ref = doc(db, 'users', user.uid, 'customers', id);
        const customerData = { ...customer, id, updatedAt: new Date().toISOString() };
        await setDoc(ref, customerData);
        
        // ä¿®å¤é—®é¢˜4ï¼šæ›´æ–°æ‰€æœ‰å¹´ä»½çš„ç›¸å…³è®¢å•
        if (customer.id) {
          const batch = writeBatch(db);
          const allYears = Object.keys(yearlyData);
          
          for (const year of allYears) {
            const yearOrdersRef = collection(db, 'users', user.uid, 'orders', String(year), 'items');
            const snapshot = await getDocs(yearOrdersRef);
            
            snapshot.forEach(doc => {
              const orderData = doc.data();
              if (orderData.customerId === customer.id) {
                batch.update(doc.ref, {
                  customerName: customer.name,
                  customerPhone: customer.phone,
                  deliveryAddress: customer.address || orderData.deliveryAddress
                });
              }
            });
          }
          
          await batch.commit();
        }
      };

      const deleteCustomer = async (id) => {
        if (!user) return;
        await window.firebase.deleteDoc(doc(db, 'users', user.uid, 'customers', id));
      };

      const saveProduct = async (product) => {
        if (!user) return;
        const id = product.id || `product_${Date.now()}`;
        const ref = doc(db, 'users', user.uid, 'products', id);
        await setDoc(ref, { ...product, id, updatedAt: new Date().toISOString() });
      };

      const deleteProduct = async (id) => {
        if (!user) return;
        await window.firebase.deleteDoc(doc(db, 'users', user.uid, 'products', id));
      };

      const saveYearlyData = async (data) => {
        if (!user) return;
        await setDoc(doc(db, 'users', user.uid, 'data', 'yearlyData'), data);
      };

      const saveSettings = async (s) => {
        if (!user) return;
        await setDoc(doc(db, 'users', user.uid, 'data', 'settings'), s);
        setSettings(s);
      };

      return {
        orders, customers, products, yearlyData, settings, currentYear,
        setCurrentYear, saveOrder, deleteOrder, saveCustomer, deleteCustomer,
        saveProduct, deleteProduct, saveYearlyData, saveSettings, setYearlyData
      };
    };

    const LoginPage = ({ onSignIn }) => (
      <div className="login-container">
        <div className="bg-white p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
          <div className="text-center mb-8">
            <div className="text-6xl mb-4">ğŸª</div>
            <h1 className="text-3xl font-bold text-gray-800 mb-2">é¥¼å¹²è®¢å•ç®¡ç†</h1>
            <p className="text-gray-600 mb-4">å¦ˆå¦ˆçš„æ‰‹å·¥é¥¼å¹²è®¢å•å°åŠ©æ‰‹</p>
            <div className="text-sm text-gray-500 bg-blue-50 p-3 rounded-lg mb-4">
              <p className="font-medium text-blue-800 mb-2">ä¸ºä»€ä¹ˆéœ€è¦ç™»å½•?</p>
              <ul className="text-left space-y-1">
                <li>â€¢ æ•°æ®å®‰å…¨å­˜å‚¨åœ¨äº‘ç«¯</li>
                <li>â€¢ å¤šè®¾å¤‡åŒæ­¥ä½¿ç”¨</li>
                <li>â€¢ æ¯ä¸ªè´¦å·æ•°æ®ç‹¬ç«‹</li>
              </ul>
            </div>
          </div>
          <button onClick={onSignIn} className="w-full bg-white border-2 border-gray-300 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-50 flex items-center justify-center gap-3">
            <span>ğŸ”</span>ä½¿ç”¨ Google è´¦å·ç™»å½•
          </button>
        </div>
      </div>
    );

    const ConfirmDialog = ({ show, title, message, onConfirm, onCancel }) => {
      if (!show) return null;
      
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] p-4">
          <div className="bg-white rounded-lg max-w-sm w-full p-6">
            <h3 className="text-lg font-bold mb-2">{title}</h3>
            <p className="text-gray-600 mb-6">{message}</p>
            <div className="flex gap-3">
              <button onClick={onCancel} className="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium">
                å¦
              </button>
              <button onClick={onConfirm} className="flex-1 py-2 bg-pink-500 text-white rounded-lg font-medium">
                æ˜¯
              </button>
            </div>
          </div>
        </div>
      );
    };

    const App = () => {
      const { user, loading, signIn, signOut, ready } = useAuth();
      const data = useData(user);
      
      const [activeTab, setActiveTab] = useState('home');
      const [searchTerm, setSearchTerm] = useState('');
      const [showOrderForm, setShowOrderForm] = useState(false);
      const [showCustomerForm, setShowCustomerForm] = useState(false);
      const [showProductForm, setShowProductForm] = useState(false);
      const [showSettingsMenu, setShowSettingsMenu] = useState(false);
      const [showFilterPanel, setShowFilterPanel] = useState(false);
      const [editingOrder, setEditingOrder] = useState(null);
      const [editingCustomer, setEditingCustomer] = useState(null);
      const [editingProduct, setEditingProduct] = useState(null);
      const [calendarDate, setCalendarDate] = useState(new Date());
      const [showYearSelector, setShowYearSelector] = useState(false);
      const [showConfirmDialog, setShowConfirmDialog] = useState(false);
      const [pendingStatusChange, setPendingStatusChange] = useState(null);
      const [selectedCalendarOrders, setSelectedCalendarOrders] = useState(null);
      
      const [filterStatus, setFilterStatus] = useState('all');
      const [filterDateType, setFilterDateType] = useState('all');

      const [orderForm, setOrderForm] = useState({
        customerName: '', customerPhone: '', products: [{ name: '', size: '', quantity: 1, price: 0 }],
        totalAmount: 0, orderDate: new Date().toISOString().split('T')[0],
        deliveryDate: '', status: 'pending', notes: '', deliveryAddress: ''
      });

      const [customerForm, setCustomerForm] = useState({ name: '', phone: '', address: '', notes: '' });
      const [productForm, setProductForm] = useState({ name: '', sizes: [{ name: '', price: 0 }], unit: 'ç›’', description: '' });

      if (!ready || loading) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-pink-50">
            <div className="text-center"><div className="text-6xl mb-4 animate-bounce">ğŸª</div><p className="text-gray-600">åŠ è½½ä¸­...</p></div>
          </div>
        );
      }

      if (!user) return <LoginPage onSignIn={signIn} />;

      // è¿‡æ»¤è®¢å•
      const filteredOrders = data.orders.filter(o => {
        if (searchTerm) {
          const matchSearch = (
            o.customerName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
            o.customerPhone?.includes(searchTerm) ||
            o.id?.includes(searchTerm)
          );
          if (!matchSearch) return false;
        }
        
        if (filterStatus !== 'all' && o.status !== filterStatus) {
          return false;
        }
        
        if (filterDateType !== 'all') {
          const today = new Date().toISOString().split('T')[0];
          if (filterDateType === 'past' && (!o.deliveryDate || o.deliveryDate >= today)) {
            return false;
          }
          if (filterDateType === 'upcoming' && (!o.deliveryDate || o.deliveryDate < today)) {
            return false;
          }
        }
        
        return true;
      }).sort((a, b) => {
        if (!a.deliveryDate) return 1;
        if (!b.deliveryDate) return -1;
        return new Date(a.deliveryDate) - new Date(b.deliveryDate);
      });

      // ä¿®å¤é—®é¢˜6ï¼šåªè®¡ç®—å·²äº¤ä»˜çŠ¶æ€çš„è¥ä¸šé¢
      const stats = {
        total: data.orders.length,
        pending: data.orders.filter(o => o.status === 'pending').length,
        processing: data.orders.filter(o => o.status === 'processing').length,
        completed: data.orders.filter(o => o.status === 'completed').length,
        delivered: data.orders.filter(o => o.status === 'delivered').length,
        revenue: data.orders.filter(o => o.status === 'delivered').reduce((sum, o) => sum + (o.totalAmount || 0), 0)
      };

      const deliveredProducts = {};
      data.orders.filter(o => o.status === 'delivered').forEach(order => {
        order.products?.forEach(p => {
          const key = `${p.name}-${p.size}`;
          if (!deliveredProducts[key]) {
            deliveredProducts[key] = { name: p.name, size: p.size, quantity: 0, revenue: 0 };
          }
          deliveredProducts[key].quantity += p.quantity;
          deliveredProducts[key].revenue += p.price * p.quantity;
        });
      });

      const addOrder = () => {
        setEditingOrder(null);
        setOrderForm({
          customerName: '', customerPhone: '', products: [{ name: '', size: '', quantity: 1, price: 0 }],
          totalAmount: 0, orderDate: new Date().toISOString().split('T')[0],
          deliveryDate: '', status: 'pending', notes: '', deliveryAddress: ''
        });
        setShowOrderForm(true);
      };

      const editOrder = (order) => {
        setEditingOrder(order);
        setOrderForm(order);
        setShowOrderForm(true);
      };

      const saveOrder = async () => {
        if (!orderForm.customerName || !orderForm.customerPhone) {
          alert('è¯·å¡«å†™å®¢æˆ·å§“åå’Œç”µè¯');
          return;
        }
        
        // ä¿®å¤é—®é¢˜2ï¼šè½¬æ¢ä¸ºå·²äº¤ä»˜æ—¶éœ€è¦ç¡®è®¤
        if (orderForm.status === 'delivered' && editingOrder && editingOrder.status !== 'delivered') {
          setPendingStatusChange({ ...orderForm, id: editingOrder?.id, createdAt: editingOrder?.createdAt || new Date().toISOString() });
          setShowConfirmDialog(true);
          return;
        }
        
        await data.saveOrder({ 
          ...orderForm, 
          id: editingOrder?.id, 
          createdAt: editingOrder?.createdAt || new Date().toISOString()
        });
        setShowOrderForm(false);
        setEditingOrder(null);
      };

      const confirmDelivery = async () => {
        if (pendingStatusChange) {
          await data.saveOrder(pendingStatusChange);
          setShowOrderForm(false);
          setEditingOrder(null);
        }
        setShowConfirmDialog(false);
        setPendingStatusChange(null);
      };

      const addCustomer = () => {
        setEditingCustomer(null);
        setCustomerForm({ name: '', phone: '', address: '', notes: '' });
        setShowCustomerForm(true);
      };

      const editCustomer = (c) => {
        setEditingCustomer(c);
        setCustomerForm(c);
        setShowCustomerForm(true);
      };

      const saveCustomer = async () => {
        if (!customerForm.name || !customerForm.phone) {
          alert('è¯·å¡«å†™å®¢æˆ·å§“åå’Œç”µè¯');
          return;
        }
        await data.saveCustomer({ 
          ...customerForm, 
          id: editingCustomer?.id, 
          createdAt: editingCustomer?.createdAt || new Date().toISOString() 
        });
        setShowCustomerForm(false);
        setEditingCustomer(null);
      };

      const addProduct = () => {
        setEditingProduct(null);
        setProductForm({ name: '', sizes: [{ name: '', price: 0 }], unit: 'ç›’', description: '' });
        setShowProductForm(true);
      };

      const editProduct = (p) => {
        setEditingProduct(p);
        setProductForm(p);
        setShowProductForm(true);
      };

      const saveProduct = async () => {
        if (!productForm.name || productForm.sizes.length === 0) {
          alert('è¯·å¡«å†™äº§å“åç§°å’Œè‡³å°‘ä¸€ä¸ªä»·æ ¼');
          return;
        }
        await data.saveProduct({ 
          ...productForm, 
          id: editingProduct?.id, 
          createdAt: editingProduct?.createdAt || new Date().toISOString() 
        });
        setShowProductForm(false);
        setEditingProduct(null);
      };

      const updateOrderProduct = (idx, field, val) => {
        const prods = [...orderForm.products];
        prods[idx] = { ...prods[idx], [field]: val };
        setOrderForm({ ...orderForm, products: prods });
        const total = prods.reduce((s, p) => s + (p.price * p.quantity), 0);
        setOrderForm(prev => ({ ...prev, totalAmount: total }));
      };

      const addOrderProduct = () => {
        setOrderForm({ ...orderForm, products: [...orderForm.products, { name: '', size: '', quantity: 1, price: 0 }] });
      };

      const removeOrderProduct = (idx) => {
        const prods = orderForm.products.filter((_, i) => i !== idx);
        setOrderForm({ ...orderForm, products: prods });
      };

      const selectCustomerForOrder = (c) => {
        setOrderForm({ ...orderForm, customerName: c.name, customerPhone: c.phone, deliveryAddress: c.address || '' });
      };

      const selectProductForOrder = (p, idx) => {
        const prods = [...orderForm.products];
        prods[idx] = { ...prods[idx], name: p.name, size: p.sizes[0]?.name || '', price: p.sizes[0]?.price || 0 };
        setOrderForm({ ...orderForm, products: prods });
      };

      const updateProductPrice = (pidx, sizeName) => {
        const p = data.products.find(pr => pr.name === orderForm.products[pidx].name);
        if (p) {
          const s = p.sizes.find(sz => sz.name === sizeName);
          if (s) updateOrderProduct(pidx, 'price', s.price);
        }
      };

      const addProductSize = () => {
        setProductForm({ ...productForm, sizes: [...productForm.sizes, { name: '', price: 0 }] });
      };

      const removeProductSize = (idx) => {
        setProductForm({ ...productForm, sizes: productForm.sizes.filter((_, i) => i !== idx) });
      };

      const updateProductSize = (idx, field, val) => {
        const sizes = [...productForm.sizes];
        sizes[idx] = { ...sizes[idx], [field]: val };
        setProductForm({ ...productForm, sizes });
      };

      const getCalendarDays = () => {
        const y = calendarDate.getFullYear();
        const m = calendarDate.getMonth();
        const firstDay = new Date(y, m, 1);
        const lastDay = new Date(y, m + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDay = firstDay.getDay();
        const days = [];
        for (let i = 0; i < startDay; i++) days.push(null);
        for (let i = 1; i <= daysInMonth; i++) days.push(i);
        return days;
      };

      const getOrdersForDate = (day) => {
        if (!day) return [];
        const dateStr = `${calendarDate.getFullYear()}-${String(calendarDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        return data.orders.filter(o => o.deliveryDate === dateStr);
      };

      const changeMonth = (delta) => {
        const newDate = new Date(calendarDate);
        newDate.setMonth(newDate.getMonth() + delta);
        setCalendarDate(newDate);
      };

      const showOrdersForDate = (day) => {
        const orders = getOrdersForDate(day);
        if (orders.length > 0) {
          setSelectedCalendarOrders(orders);
        }
      };

      const createNewYear = async () => {
        const year = prompt('è¯·è¾“å…¥æ–°å¹´ä»½ï¼ˆä¾‹å¦‚ï¼š2025ï¼‰ï¼š');
        if (year && !isNaN(year) && year.length === 4) {
          const y = parseInt(year);
          const newData = { ...data.yearlyData, [y]: { settled: false } };
          await data.saveYearlyData(newData);
          data.setYearlyData(newData);
          data.setCurrentYear(y);
          setShowYearSelector(false);
        } else {
          alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å¹´ä»½');
        }
      };

      const updateYearlyTarget = async () => {
        const target = prompt('è¯·è¾“å…¥å¹´åº¦è¥ä¸šé¢ç›®æ ‡ï¼ˆå…ƒï¼‰ï¼š', data.settings.yearlyTarget || 0);
        if (target !== null) {
          await data.saveSettings({ ...data.settings, yearlyTarget: parseFloat(target) || 0 });
        }
      };

      const statusColors = {
        pending: 'bg-orange-100 text-orange-700',
        processing: 'bg-blue-100 text-blue-700',
        completed: 'bg-green-100 text-green-700',
        delivered: 'bg-purple-100 text-purple-700',
        cancelled: 'bg-gray-100 text-gray-700'
      };

      const statusLabels = {
        pending: 'å¾…å¤„ç†',
        processing: 'åˆ¶ä½œä¸­',
        completed: 'å·²å®Œæˆ',
        delivered: 'å·²äº¤ä»˜',
        cancelled: 'å·²å–æ¶ˆ'
      };

      const progressPercent = data.settings.yearlyTarget > 0 
        ? Math.min((stats.revenue / data.settings.yearlyTarget) * 100, 100)
        : 0;

      return (
        <div className="min-h-screen bg-gray-50 pb-20">
          {/* é¡¶éƒ¨æ  */}
          <div className="bg-gradient-to-r from-pink-500 to-pink-600 text-white p-4 sticky top-0 z-10 shadow-lg">
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-3">
                <span className="text-2xl">ğŸª</span>
                <div>
                  <h1 className="text-xl font-bold">é¥¼å¹²è®¢å•ç®¡ç†</h1>
                  <p className="text-xs opacity-90">{user.displayName || user.email}</p>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <button onClick={() => setShowYearSelector(!showYearSelector)} className="bg-white bg-opacity-20 px-3 py-2 rounded-lg text-sm font-medium">
                  {data.currentYear}å¹´
                </button>
                <button onClick={() => setShowSettingsMenu(!showSettingsMenu)} className="bg-white bg-opacity-20 p-2 rounded-lg relative">
                  <Icons.Settings size={20} />
                </button>
              </div>
            </div>
          </div>

          {/* è®¾ç½®èœå• */}
          {showSettingsMenu && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-lg max-w-md w-full p-4">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-bold">è®¾ç½®</h3>
                  <button onClick={() => setShowSettingsMenu(false)} className="text-gray-500">
                    <Icons.X size={24} />
                  </button>
                </div>
                
                <div className="space-y-4">
                  <div className="bg-gray-50 p-4 rounded-lg">
                    <h4 className="font-medium mb-2">è´¦å·ä¿¡æ¯</h4>
                    <div className="text-sm space-y-1">
                      <p className="text-gray-600">é‚®ç®±: {user.email}</p>
                      <p className="text-gray-600">å§“å: {user.displayName || 'æœªè®¾ç½®'}</p>
                    </div>
                  </div>
                  
                  <div className="bg-gray-50 p-4 rounded-lg">
                    <h4 className="font-medium mb-2">å¹´åº¦è®¾ç½®</h4>
                    <button onClick={updateYearlyTarget} className="w-full py-2 bg-pink-500 text-white rounded-lg text-sm">
                      è®¾ç½®å¹´åº¦è¥ä¸šé¢ç›®æ ‡
                    </button>
                    {data.settings.yearlyTarget > 0 && (
                      <p className="text-sm text-gray-600 mt-2">å½“å‰ç›®æ ‡: RM {data.settings.yearlyTarget}</p>
                    )}
                  </div>
                  
                  <div className="bg-gray-50 p-4 rounded-lg">
                    <h4 className="font-medium mb-2">æ•°æ®åŒæ­¥</h4>
                    <div className="flex items-center gap-2 text-green-600 text-sm">
                      <Icons.Check size={16} />
                      <span>äº‘ç«¯åŒæ­¥å·²å¯ç”¨</span>
                    </div>
                  </div>
                  
                  <button onClick={signOut} className="w-full py-3 bg-red-500 text-white rounded-lg font-medium flex items-center justify-center gap-2">
                    <Icons.LogOut size={20} />
                    é€€å‡ºç™»å½•
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* å¹´ä»½é€‰æ‹©å™¨ */}
          {showYearSelector && (
            <div className="absolute top-16 right-4 bg-white rounded-lg shadow-lg p-3 z-20">
              <div className="space-y-1">
                {Object.keys(data.yearlyData).sort((a, b) => b - a).map(y => (
                  <button key={y} onClick={() => { data.setCurrentYear(parseInt(y)); setShowYearSelector(false); }}
                    className={`block w-full text-left px-4 py-2 rounded ${data.currentYear === parseInt(y) ? 'bg-pink-100 text-pink-700 font-medium' : 'hover:bg-gray-50'}`}>
                    {y}å¹´ {data.yearlyData[y].settled && '(å·²ç»“ç®—)'}
                  </button>
                ))}
                <button onClick={createNewYear} className="w-full text-left px-4 py-2 text-pink-600 hover:bg-pink-50 rounded font-medium">
                  + åˆ›å»ºæ–°å¹´ä»½
                </button>
              </div>
            </div>
          )}

          {/* ä¿®å¤é—®é¢˜2ï¼šç¡®è®¤å¯¹è¯æ¡† z-index æé«˜åˆ°100 */}
          <ConfirmDialog
            show={showConfirmDialog}
            title="ç¡®è®¤äº¤ä»˜"
            message="ç¡®è®¤è®¢å•å·²äº¤ä»˜ç»™å®¢æˆ·ï¼Ÿ"
            onConfirm={confirmDelivery}
            onCancel={() => {
              setShowConfirmDialog(false);
              setPendingStatusChange(null);
            }}
          />

          {/* æ—¥å†è®¢å•è¯¦æƒ…å¼¹çª— */}
          {selectedCalendarOrders && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50 p-4">
              <div className="bg-white w-full sm:max-w-lg sm:rounded-lg rounded-t-lg max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-white border-b px-4 py-3 flex justify-between items-center">
                  <h2 className="text-xl font-bold">è®¢å•è¯¦æƒ…</h2>
                  <button onClick={() => setSelectedCalendarOrders(null)} className="text-gray-500">
                    <Icons.X size={24} />
                  </button>
                </div>
                <div className="p-4 space-y-3">
                  {selectedCalendarOrders.map(order => (
                    <div key={order.id} className="bg-gray-50 p-4 rounded-lg">
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <div className="font-bold text-lg">{order.customerName}</div>
                          <div className="text-sm text-gray-600">{order.customerPhone}</div>
                        </div>
                        <span className={`text-xs px-2 py-1 rounded ${statusColors[order.status]}`}>
                          {statusLabels[order.status]}
                        </span>
                      </div>
                      <div className="space-y-1 text-sm mb-2">
                        {order.products?.map((p, i) => (
                          <div key={i}>{p.name} ({p.size}) x {p.quantity}</div>
                        ))}
                      </div>
                      <div className="flex justify-between items-center pt-2 border-t">
                        <span className="text-sm text-gray-600">äº¤ä»˜: {order.deliveryDate}</span>
                        <span className="font-bold text-pink-600">RM {order.totalAmount?.toFixed(2)}</span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          <div className="p-4">
            {/* ä¸»é¡µ */}
            {activeTab === 'home' && (
              <div className="space-y-4">
                <h2 className="text-xl font-bold">ç»Ÿè®¡æ¦‚è§ˆ</h2>
                
                {/* è¥ä¸šé¢å¡ç‰‡ */}
                <div className="bg-white p-4 rounded-lg shadow">
                  <div className="flex justify-between items-start mb-2">
                    <div>
                      <div className="text-gray-600 text-sm">è¥ä¸šé¢</div>
                      <div className="text-3xl font-bold text-pink-600">RM {stats.revenue.toFixed(2)}</div>
                    </div>
                    <Icons.TrendingUp size={32} className="text-pink-500" />
                  </div>
                  {data.settings.yearlyTarget > 0 && (
                    <>
                      <div className="text-xs text-gray-500 mb-2">
                        ç›®æ ‡: RM {data.settings.yearlyTarget} ({progressPercent.toFixed(1)}%)
                      </div>
                      <div className="progress-bar">
                        <div className="progress-fill" style={{ width: `${progressPercent}%` }}></div>
                      </div>
                    </>
                  )}
                </div>

                {/* è®¢å•ç»Ÿè®¡ */}
                <div className="grid grid-cols-2 gap-3">
                  <div className="bg-white p-4 rounded-lg shadow">
                    <div className="text-gray-600 text-sm mb-1">æ€»è®¢å•</div>
                    <div className="text-2xl font-bold text-gray-800">{stats.total}</div>
                  </div>
                  <div className="bg-white p-4 rounded-lg shadow">
                    <div className="text-gray-600 text-sm mb-1">å¾…å¤„ç†</div>
                    <div className="text-2xl font-bold text-orange-600">{stats.pending}</div>
                  </div>
                  <div className="bg-white p-4 rounded-lg shadow">
                    <div className="text-gray-600 text-sm mb-1">åˆ¶ä½œä¸­</div>
                    <div className="text-2xl font-bold text-blue-600">{stats.processing}</div>
                  </div>
                  <div className="bg-white p-4 rounded-lg shadow">
                    <div className="text-gray-600 text-sm mb-1">å·²å®Œæˆ</div>
                    <div className="text-2xl font-bold text-green-600">{stats.completed}</div>
                  </div>
                  <div className="bg-white p-4 rounded-lg shadow col-span-2">
                    <div className="text-gray-600 text-sm mb-1">å·²äº¤ä»˜</div>
                    <div className="text-2xl font-bold text-purple-600">{stats.delivered}</div>
                  </div>
                </div>

                {/* å·²äº¤ä»˜äº§å“ç»Ÿè®¡ */}
                {Object.keys(deliveredProducts).length > 0 && (
                  <div className="bg-white p-4 rounded-lg shadow">
                    <h3 className="font-bold mb-3">å·²äº¤ä»˜äº§å“</h3>
                    <div className="space-y-2">
                      {Object.values(deliveredProducts).map((item, i) => (
                        <div key={i} className="flex justify-between items-center text-sm">
                          <div>
                            <span className="font-medium">{item.name}</span>
                            <span className="text-gray-600"> ({item.size})</span>
                          </div>
                          <div className="text-right">
                            <div>{item.quantity} ä»½</div>
                            <div className="text-pink-600 font-medium">RM {item.revenue.toFixed(2)}</div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* è®¢å•é¡µ */}
            {activeTab === 'orders' && (
              <div>
                <div className="mb-4 flex gap-2">
                  <div className="flex-1 relative">
                    <Icons.Search className="absolute left-3 top-3 text-gray-400" size={20} />
                    <input type="text" placeholder="æœç´¢è®¢å•..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)}
                      className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg" />
                  </div>
                  <button onClick={() => setShowFilterPanel(!showFilterPanel)} className="p-2 border border-gray-300 rounded-lg bg-white">
                    <Icons.Filter size={20} />
                  </button>
                </div>

                {/* è¿‡æ»¤é¢æ¿ */}
                {showFilterPanel && (
                  <div className="mb-4 p-4 bg-white rounded-lg shadow space-y-3">
                    <div>
                      <label className="block text-sm font-medium mb-2">è®¢å•çŠ¶æ€</label>
                      <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)}
                        className="w-full px-3 py-2 border rounded-lg">
                        <option value="all">å…¨éƒ¨</option>
                        <option value="pending">å¾…å¤„ç†</option>
                        <option value="processing">åˆ¶ä½œä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="delivered">å·²äº¤ä»˜</option>
                        <option value="cancelled">å·²å–æ¶ˆ</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-2">äº¤ä»˜æ—¶é—´</label>
                      <select value={filterDateType} onChange={(e) => setFilterDateType(e.target.value)}
                        className="w-full px-3 py-2 border rounded-lg">
                        <option value="all">å…¨éƒ¨</option>
                        <option value="past">å·²è¿‡æœŸ</option>
                        <option value="upcoming">å³å°†åˆ°æ¥</option>
                      </select>
                    </div>
                    <button onClick={() => { setFilterStatus('all'); setFilterDateType('all'); }}
                      className="w-full py-2 bg-gray-200 rounded-lg text-sm font-medium">
                      æ¸…é™¤è¿‡æ»¤
                    </button>
                  </div>
                )}

                <div className="space-y-3">
                  {filteredOrders.length === 0 ? (
                    <div className="text-center py-12 text-gray-500">
                      <Icons.Package size={48} className="mx-auto mb-2 opacity-50" />
                      <p>æ²¡æœ‰æ‰¾åˆ°è®¢å•</p>
                    </div>
                  ) : (
                    filteredOrders.map(order => (
                      <div key={order.id} className="bg-white p-4 rounded-lg shadow">
                        <div className="flex justify-between items-start mb-2">
                          <div className="flex-1">
                            <div className="font-bold text-lg">{order.customerName}</div>
                            <div className="text-sm text-gray-600">{order.customerPhone}</div>
                          </div>
                          <div className="flex gap-2">
                            <button onClick={() => editOrder(order)} className="text-blue-600 p-1">
                              <Icons.Edit size={18} />
                            </button>
                            {/* ä¿®å¤é—®é¢˜5ï¼šåªæœ‰å¾…å¤„ç†çš„è®¢å•å¯ä»¥åˆ é™¤ */}
                            {order.status === 'pending' && (
                              <button onClick={() => confirm('ç¡®å®šåˆ é™¤?') && data.deleteOrder(order.id)} className="text-red-600 p-1">
                                <Icons.Trash size={18} />
                              </button>
                            )}
                          </div>
                        </div>
                        <div className="space-y-1 text-sm mb-2">
                          {order.products?.map((p, i) => (
                            <div key={i} className="text-gray-700">{p.name} ({p.size}) x {p.quantity} - RM {(p.price * p.quantity).toFixed(2)}</div>
                          ))}
                        </div>
                        <div className="flex justify-between items-center pt-2 border-t">
                          <div className="text-sm text-gray-600">äº¤ä»˜: {order.deliveryDate || 'æœªè®¾ç½®'}</div>
                          <div className="flex items-center gap-2">
                            <span className={`text-xs px-2 py-1 rounded ${statusColors[order.status]}`}>
                              {statusLabels[order.status]}
                            </span>
                            <span className="font-bold text-pink-600">RM {order.totalAmount?.toFixed(2) || '0.00'}</span>
                          </div>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            )}

            {/* ä¿®å¤é—®é¢˜1ï¼šæ—¥å†é¡µé¢ */}
            {activeTab === 'calendar' && (
              <div className="bg-white rounded-lg shadow p-4">
                <div className="flex justify-between items-center mb-4">
                  <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-gray-100 rounded"><Icons.ChevronLeft size={24} /></button>
                  <h2 className="text-xl font-bold">{calendarDate.getFullYear()}å¹´ {calendarDate.getMonth() + 1}æœˆ</h2>
                  <button onClick={() => changeMonth(1)} className="p-2 hover:bg-gray-100 rounded"><Icons.ChevronRight size={24} /></button>
                </div>
                {/* ä½¿ç”¨ä¿®å¤çš„æ—¥å†å¤´éƒ¨ */}
                <div className="calendar-header mb-2">
                  {['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(d => (
                    <div key={d} className="text-center text-sm font-medium text-gray-600 py-2">{d}</div>
                  ))}
                </div>
                <div className="calendar-grid">
                  {getCalendarDays().map((day, i) => {
                    const orders = day ? getOrdersForDate(day) : [];
                    return (
                      <div key={i} onClick={() => day && showOrdersForDate(day)}
                        className={`calendar-day border rounded p-1 ${day ? 'bg-white hover:bg-gray-50' : 'bg-gray-100'} ${orders.length > 0 ? 'border-pink-300' : 'border-gray-200'}`}>
                        {day && (
                          <>
                            <div className="text-sm font-medium mb-1">{day}</div>
                            {orders.length > 0 && (
                              <div className="space-y-1">
                                {orders.slice(0, 2).map((o, idx) => (
                                  <div key={idx} className="text-xs bg-pink-100 text-pink-700 px-1 py-0.5 rounded truncate cursor-pointer">
                                    {o.customerName}
                                  </div>
                                ))}
                                {orders.length > 2 && <div className="text-xs text-gray-600 px-1">+{orders.length - 2}</div>}
                              </div>
                            )}
                          </>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* å®¢æˆ·é¡µ */}
            {activeTab === 'customers' && (
              <div>
                <div className="space-y-3">
                  {data.customers.map(c => (
                    <div key={c.id} className="bg-white p-4 rounded-lg shadow">
                      <div className="flex justify-between items-start">
                        <div className="flex-1">
                          <div className="font-bold text-lg">{c.name}</div>
                          <div className="text-sm text-gray-600">{c.phone}</div>
                          {c.address && <div className="text-sm text-gray-600 mt-1">{c.address}</div>}
                        </div>
                        <div className="flex gap-2">
                          <button onClick={() => editCustomer(c)} className="text-blue-600 p-1"><Icons.Edit size={18} /></button>
                          <button onClick={() => confirm('ç¡®å®šåˆ é™¤?') && data.deleteCustomer(c.id)} className="text-red-600 p-1"><Icons.Trash size={18} /></button>
                        </div>
                      </div>
                      {c.notes && <div className="text-sm text-gray-600 mt-2 pt-2 border-t">å¤‡æ³¨: {c.notes}</div>}
                    </div>
                  ))}
                </div>
                {data.customers.length === 0 && (
                  <div className="text-center py-12 text-gray-500"><Icons.Users size={48} className="mx-auto mb-2 opacity-50" /><p>è¿˜æ²¡æœ‰å®¢æˆ·</p></div>
                )}
              </div>
            )}

            {/* äº§å“é¡µ */}
            {activeTab === 'products' && (
              <div className="space-y-3">
                {data.products.map(p => (
                  <div key={p.id} className="bg-white p-4 rounded-lg shadow">
                    <div className="flex justify-between items-start mb-2">
                      <div className="flex-1">
                        <div className="font-bold text-lg">{p.name}</div>
                        {p.description && <div className="text-sm text-gray-600 mt-1">{p.description}</div>}
                      </div>
                      <div className="flex gap-2">
                        <button onClick={() => editProduct(p)} className="text-blue-600 p-1"><Icons.Edit size={18} /></button>
                        <button onClick={() => confirm('ç¡®å®šåˆ é™¤?') && data.deleteProduct(p.id)} className="text-red-600 p-1"><Icons.Trash size={18} /></button>
                      </div>
                    </div>
                    <div className="mt-2 space-y-1">
                      {p.sizes.map((s, i) => (
                        <div key={i} className="flex justify-between text-sm"><span>{s.name}</span><span className="font-medium text-pink-600">RM {s.price}</span></div>
                      ))}
                    </div>
                    {p.unit && <div className="text-xs text-gray-500 mt-2">å•ä½: {p.unit}</div>}
                  </div>
                ))}
                {data.products.length === 0 && (
                  <div className="text-center py-12 text-gray-500"><Icons.Package size={48} className="mx-auto mb-2 opacity-50" /><p>è¿˜æ²¡æœ‰äº§å“</p></div>
                )}
              </div>
            )}
          </div>

          {/* åº•éƒ¨å¯¼èˆª */}
          <div className="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg">
            <div className="flex justify-around py-2">
              <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center p-2 ${activeTab === 'home' ? 'text-pink-600' : 'text-gray-600'}`}>
                <Icons.Home size={24} /><span className="text-xs mt-1">ä¸»é¡µ</span>
              </button>
              <button onClick={() => setActiveTab('orders')} className={`flex flex-col items-center p-2 ${activeTab === 'orders' ? 'text-pink-600' : 'text-gray-600'}`}>
                <Icons.Package size={24} /><span className="text-xs mt-1">è®¢å•</span>
              </button>
              <button onClick={addOrder} className="flex flex-col items-center p-2 -mt-4">
                <div className="bg-pink-500 text-white rounded-full p-3 shadow-lg"><Icons.Plus size={28} /></div>
              </button>
              <button onClick={() => setActiveTab('calendar')} className={`flex flex-col items-center p-2 ${activeTab === 'calendar' ? 'text-pink-600' : 'text-gray-600'}`}>
                <Icons.Calendar size={24} /><span className="text-xs mt-1">æ—¥å†</span>
              </button>
              <button onClick={() => setActiveTab('customers')} className={`flex flex-col items-center p-2 ${activeTab === 'customers' ? 'text-pink-600' : 'text-gray-600'}`}>
                <Icons.Users size={24} /><span className="text-xs mt-1">å®¢æˆ·</span>
              </button>
            </div>
          </div>

          {/* è®¢å•è¡¨å• */}
          {showOrderForm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50">
              <div className="bg-white w-full sm:max-w-2xl sm:rounded-lg rounded-t-lg max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-white border-b px-4 py-3 flex justify-between items-center z-10">
                  <h2 className="text-xl font-bold">{editingOrder ? 'ç¼–è¾‘è®¢å•' : 'æ–°å¢è®¢å•'}</h2>
                  <button onClick={() => setShowOrderForm(false)} className="text-gray-500"><Icons.X size={24} /></button>
                </div>
                <div className="p-4 space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">å®¢æˆ·ä¿¡æ¯ *</label>
                    <div className="grid grid-cols-2 gap-2">
                      <input type="text" placeholder="å®¢æˆ·å§“å" value={orderForm.customerName}
                        onChange={(e) => setOrderForm({ ...orderForm, customerName: e.target.value })}
                        className="px-3 py-2 border rounded" />
                      <input type="tel" placeholder="ç”µè¯" value={orderForm.customerPhone}
                        onChange={(e) => setOrderForm({ ...orderForm, customerPhone: e.target.value })}
                        className="px-3 py-2 border rounded" />
                    </div>
                    <details className="mt-2">
                      <summary className="text-sm text-pink-600 cursor-pointer">ä»å®¢æˆ·åˆ—è¡¨é€‰æ‹©</summary>
                      <div className="mt-2 max-h-32 overflow-y-auto space-y-1">
                        {data.customers.map(c => (
                          <div key={c.id} onClick={() => selectCustomerForOrder(c)}
                            className="p-2 hover:bg-pink-50 rounded cursor-pointer text-sm">
                            {c.name} - {c.phone}
                          </div>
                        ))}
                      </div>
                    </details>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">åœ°å€</label>
                    <input type="text" placeholder="äº¤ä»˜åœ°å€" value={orderForm.deliveryAddress}
                      onChange={(e) => setOrderForm({ ...orderForm, deliveryAddress: e.target.value })}
                      className="w-full px-3 py-2 border rounded" />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">äº§å“åˆ—è¡¨ *</label>
                    {orderForm.products.map((p, i) => (
                      <div key={i} className="mb-3 p-3 bg-gray-50 rounded-lg">
                        <div className="flex justify-between items-center mb-2">
                          <span className="text-sm font-medium">äº§å“ {i + 1}</span>
                          {orderForm.products.length > 1 && (
                            <button onClick={() => removeOrderProduct(i)} className="text-red-600 text-sm">åˆ é™¤</button>
                          )}
                        </div>
                        <div className="space-y-2">
                          <div className="flex gap-2">
                            <input type="text" placeholder="äº§å“åç§°" value={p.name} list={`products-${i}`}
                              onChange={(e) => updateOrderProduct(i, 'name', e.target.value)}
                              className="flex-1 px-3 py-2 border rounded" />
                            <datalist id={`products-${i}`}>
                              {data.products.map(prod => (
                                <option key={prod.id} value={prod.name} />
                              ))}
                            </datalist>
                            <button onClick={() => {
                              const prod = data.products.find(pr => pr.name === p.name);
                              if (prod) selectProductForOrder(prod, i);
                            }} className="px-3 py-2 bg-pink-500 text-white rounded text-sm">é€‰æ‹©</button>
                          </div>
                          <div className="grid grid-cols-3 gap-2">
                            <select value={p.size} onChange={(e) => { updateOrderProduct(i, 'size', e.target.value); updateProductPrice(i, e.target.value); }}
                              className="px-3 py-2 border rounded text-sm">
                              <option value="">é€‰æ‹©å¤§å°</option>
                              {data.products.find(pr => pr.name === p.name)?.sizes.map((s, idx) => (
                                <option key={idx} value={s.name}>{s.name}</option>
                              ))}
                            </select>
                            <input type="number" placeholder="æ•°é‡" value={p.quantity} min="1"
                              onChange={(e) => {
                                const val = e.target.value;
                                updateOrderProduct(i, 'quantity', val === '' ? '' : parseInt(val));
                              }}
                              className="px-3 py-2 border rounded text-sm" />
                            <input type="number" placeholder="å•ä»·" value={p.price} step="0.01"
                              onChange={(e) => updateOrderProduct(i, 'price', parseFloat(e.target.value) || 0)}
                              className="px-3 py-2 border rounded text-sm" />
                          </div>
                          <div className="px-3 py-2 bg-white border rounded text-sm flex items-center justify-end font-medium">
                            RM {(p.price * p.quantity).toFixed(2)}
                          </div>
                        </div>
                      </div>
                    ))}
                    <button onClick={addOrderProduct} className="text-pink-600 text-sm font-medium flex items-center gap-1 mt-2">
                      <Icons.Plus size={16} />æ·»åŠ äº§å“
                    </button>
                  </div>

                  <div className="bg-pink-50 p-3 rounded-lg flex justify-between items-center">
                    <span className="font-bold">è®¢å•æ€»é¢</span>
                    <span className="text-2xl font-bold text-pink-600">RM {orderForm.totalAmount.toFixed(2)}</span>
                  </div>

                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm font-medium mb-2">ä¸‹å•æ—¥æœŸ</label>
                      <input type="date" value={orderForm.orderDate}
                        onChange={(e) => setOrderForm({ ...orderForm, orderDate: e.target.value })}
                        className="w-full px-3 py-2 border rounded" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-2">äº¤ä»˜æ—¥æœŸ</label>
                      <input type="date" value={orderForm.deliveryDate}
                        onChange={(e) => setOrderForm({ ...orderForm, deliveryDate: e.target.value })}
                        className="w-full px-3 py-2 border rounded" />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">è®¢å•çŠ¶æ€</label>
                    <select value={orderForm.status} onChange={(e) => setOrderForm({ ...orderForm, status: e.target.value })}
                      className="w-full px-3 py-2 border rounded">
                      <option value="pending">å¾…å¤„ç†</option>
                      <option value="processing">åˆ¶ä½œä¸­</option>
                      <option value="completed">å·²å®Œæˆ</option>
                      <option value="delivered">å·²äº¤ä»˜</option>
                      <option value="cancelled">å·²å–æ¶ˆ</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">å¤‡æ³¨</label>
                    <textarea value={orderForm.notes} onChange={(e) => setOrderForm({ ...orderForm, notes: e.target.value })}
                      className="w-full px-3 py-2 border rounded" rows="3" />
                  </div>

                  <div className="flex gap-2 pt-4">
                    <button onClick={() => setShowOrderForm(false)} className="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium">å–æ¶ˆ</button>
                    <button onClick={saveOrder} className="flex-1 py-3 bg-pink-500 text-white rounded-lg font-medium">ä¿å­˜è®¢å•</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* å®¢æˆ·è¡¨å• */}
          {showCustomerForm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50">
              <div className="bg-white w-full sm:max-w-lg sm:rounded-lg rounded-t-lg max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-white border-b px-4 py-3 flex justify-between items-center">
                  <h2 className="text-xl font-bold">{editingCustomer ? 'ç¼–è¾‘å®¢æˆ·' : 'æ–°å¢å®¢æˆ·'}</h2>
                  <button onClick={() => setShowCustomerForm(false)} className="text-gray-500"><Icons.X size={24} /></button>
                </div>
                <div className="p-4 space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">å®¢æˆ·å§“å *</label>
                    <input type="text" value={customerForm.name}
                      onChange={(e) => setCustomerForm({ ...customerForm, name: e.target.value })}
                      className="w-full px-3 py-2 border rounded" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">ç”µè¯ *</label>
                    <input type="tel" value={customerForm.phone}
                      onChange={(e) => setCustomerForm({ ...customerForm, phone: e.target.value })}
                      className="w-full px-3 py-2 border rounded" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">åœ°å€</label>
                    <input type="text" value={customerForm.address}
                      onChange={(e) => setCustomerForm({ ...customerForm, address: e.target.value })}
                      className="w-full px-3 py-2 border rounded" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">å¤‡æ³¨</label>
                    <textarea value={customerForm.notes}
                      onChange={(e) => setCustomerForm({ ...customerForm, notes: e.target.value })}
                      className="w-full px-3 py-2 border rounded" rows="3" />
                  </div>
                  <div className="flex gap-2 pt-4">
                    <button onClick={() => setShowCustomerForm(false)} className="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium">å–æ¶ˆ</button>
                    <button onClick={saveCustomer} className="flex-1 py-3 bg-pink-500 text-white rounded-lg font-medium">ä¿å­˜å®¢æˆ·</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* äº§å“è¡¨å• */}
          {showProductForm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50">
              <div className="bg-white w-full sm:max-w-lg sm:rounded-lg rounded-t-lg max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-white border-b px-4 py-3 flex justify-between items-center">
                  <h2 className="text-xl font-bold">{editingProduct ? 'ç¼–è¾‘äº§å“' : 'æ–°å¢äº§å“'}</h2>
                  <button onClick={() => setShowProductForm(false)} className="text-gray-500"><Icons.X size={24} /></button>
                </div>
                <div className="p-4 space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">äº§å“åç§° *</label>
                    <input type="text" value={productForm.name} placeholder="ä¾‹å¦‚ï¼šå·§å…‹åŠ›æ›²å¥‡"
                      onChange={(e) => setProductForm({ ...productForm, name: e.target.value })}
                      className="w-full px-3 py-2 border rounded" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">å¤§å°å’Œä»·æ ¼ *</label>
                    {productForm.sizes.map((s, i) => (
                      <div key={i} className="flex gap-2 mb-2">
                        <input type="text" value={s.name} placeholder="å¤§å°åç§°"
                          onChange={(e) => updateProductSize(i, 'name', e.target.value)}
                          className="flex-1 px-3 py-2 border rounded" />
                        <input type="number" value={s.price} step="0.01" placeholder="ä»·æ ¼"
                          onChange={(e) => updateProductSize(i, 'price', parseFloat(e.target.value) || 0)}
                          className="w-24 px-3 py-2 border rounded" />
                        {productForm.sizes.length > 1 && (
                          <button onClick={() => removeProductSize(i)} className="p-2 text-red-600"><Icons.Trash size={20} /></button>
                        )}
                      </div>
                    ))}
                    <button onClick={addProductSize} className="text-pink-600 text-sm font-medium flex items-center gap-1">
                      <Icons.Plus size={16} />æ·»åŠ å¤§å°é€‰é¡¹
                    </button>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">å•ä½</label>
                    <input type="text" value={productForm.unit} placeholder="ç›’/åŒ…/ä¸ª"
                      onChange={(e) => setProductForm({ ...productForm, unit: e.target.value })}
                      className="w-full px-3 py-2 border rounded" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">æè¿°</label>
                    <textarea value={productForm.description} placeholder="äº§å“æè¿°æˆ–ç‰¹è‰²"
                      onChange={(e) => setProductForm({ ...productForm, description: e.target.value })}
                      className="w-full px-3 py-2 border rounded" rows="3" />
                  </div>
                  <div className="flex gap-2 pt-4">
                    <button onClick={() => setShowProductForm(false)} className="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium">å–æ¶ˆ</button>
                    <button onClick={saveProduct} className="flex-1 py-3 bg-pink-500 text-white rounded-lg font-medium">ä¿å­˜äº§å“</button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js').then(
        (registration) => {
          console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration);
        },
        (err) => {
          console.log('Service Worker æ³¨å†Œå¤±è´¥:', err);
        }
      );
    }
  </script>
</body>
</html>